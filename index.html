<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lume - Connessioni</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Belanosima:wght@400;600;700&family=Covered+By+Your+Grace&family=Dela+Gothic+One&family=Leckerli+One&family=Moirai+One&family=Pixelify+Sans:wght@587&family=Qahiri&family=Righteous&family=Rochester&family=Sigmar&family=Staatliches&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Stile di base e font */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            /* L'overflow √® gestito dai contenitori */
            background-color: #f9fafb; 
            color: #1f2937;
        }
/* Colori personalizzati estratti dal mockup */
.bg-custom-light-purple {
    background-color: #F3E8FF;
}

        /* Nasconde la scrollbar */
        .app-view::-webkit-scrollbar { display: none; }
        .app-view { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* NUOVO: Nasconde scrollbar per carosello eventi */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }


.rochester-regular {
  font-family: "Rochester", cursive;
  font-weight: 400;
  font-style: normal;
}


.fontTitle{
    font-family: "Rochester", cursive;
}

/* Colore uniforme per i pulsanti: #F7BBE1 */
.bg-custom-pink { 
    background-color: #F7BBE1;
    color: #333; /* Aggiungi un colore del testo scuro per il contrasto */
    border-color: #F7BBE1; /* Imposta il bordo con lo stesso colore */
}
.bg-custom-pink:hover {
     opacity: 0.9;
}

.txt-custom-pink { 
    
    color: #F7BBE1; /* Aggiungi un colore del testo scuro per il contrasto */

}

/* Colori specifici per la UI (es. status, icone) */
.text-custom-pink {
    color: #F7BBE1;
}
.bg-pink-100 {
    background-color: #FCE7F3; /* Un rosa pallido per sfondi */
}
.text-pink-700 {
    color: #BE185D; /* Un rosa scuro per il testo */
}
.border-pink {
    border-color: #F7BBE1;
}
.ring-pink {
    --tw-ring-color: #F7BBE1;
}


        /* Contenitore principale delle viste (App Stack) */
        .app-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Aggiunge overscroll-y-auto per lo scrolling interno se necessario */
            overflow-y: auto; 
            transition: transform 0.35s ease-out, opacity 0.35s;
            will-change: transform, opacity;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .app-view.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            z-index: 20;
        }

        .app-view.slide-from-bottom { transform: translateY(100%); }

        /* Stile Modale "Sheet" (minimalista) */
        .modal-sheet {
            transition: transform 0.3s ease-out;
            transform: translateY(100%);
        }
        .modal-sheet.open {
            transform: translateY(0);
        }

        /* Nasconde la scrollbar */
        .app-view::-webkit-scrollbar { display: none; }
        .app-view { -ms-overflow-style: none; scrollbar-width: none; }

.bordrs {
  border-radius: 25px;
    background-color: #fff;        
}

        /* Icona di trascinamento nel Modale (Minimal) */
        .handle-bar {
            width: 40px;
            height: 4px;
            background-color: #ccc;
            border-radius: 2px;
            margin: 0 auto 1rem auto;
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-gray-50 antialiased">

    <div class="relative w-full h-full overflow-hidden max-w-lg mx-auto bg-white shadow-2xl">

        <div id="loading-view" class="app-view visible flex flex-col items-center justify-center h-full bg-white">
            <svg class="animate-spin h-8 w-8 text-custom-pink mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-xl font-medium tracking-wide txt-custom-pink fontTitle">Lume</h2>
            <p class="text-gray-500 mt-1 text-sm">Caricamento...</p>
        </div>

        <div id="welcome-view" class="app-view slide-from-bottom flex flex-col justify-between p-8 bg-white">
            <div class="flex-grow flex flex-col items-center justify-center text-center">
                <div class="relative mb-12 mt-16">
                    <img src="/images/1761762271275.png" alt="Mascot Placeholder" class="w-48 h-auto mx-auto rounded-lg">
                    
                    <div class="absolute -top-10 -left-8 transform -rotate-12">
                        <div class="relative bg-whitr text-white text-lg rounded-full py-3 px-6 ">
                            
                            </div>
                    </div>
                </div>

                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Benvenut…ô in</h1><h1 class="text-6xl font-extrabold txt-custom-pink fontTitle">Lume.</h1>

            </div>
            
            <div class="flex-shrink-0">
                <button id="get-started-btn" class="w-full max-w-md mx-auto p-4 rounded-xl text-gray-900 font-semibold bg-custom-pink transition-opacity duration-300">
    Inizia
</button>

                <p class="text-center text-sm text-gray-600 pt-10">
                    Hai gi√† un account? 
                    <button id="go-to-signin-link" class="font-bold txt-custom-pink">Login</button>
                </p>
            </div>
        </div>

        <div id="signup-view" class="app-view slide-from-bottom flex flex-col bg-custom-pink">
            <div class="p-8
            1pt-15 flex justify-between items-start flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-950"></h2>
                </div>

            <div class="flex-grow bg-white rounded-t-3xl shadow-2xl p-8 overflow-y-auto">
                <h3 class="text-3xl font-bold txt-custom-pink mb-8">Registrati</h3>
                
                <form id="signup-form" class="space-y-5">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-600 mb-1">Nickname</label>
                        <input id="signup-name" type="text" placeholder="es. Cheddar üßÄ" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                        <input id="signup-email" type="email" placeholder="xoushal@uploopstudio.it" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input id="signup-password" type="password" placeholder="Lume23!!" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    
                    <button id="signup-btn" type="submit" class="w-full bg-custom-pink text-gray-900 font-semibold py-4 px-6 rounded-xl shadow-lg transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink mt-4">
                        Crea Profilo
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink mx-4 text-sm text-gray-400">Or sign up with</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="flex gap-4">
                    <button id="signup-google-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-gray-100 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M47.5 24.037C47.5 22.462 47.362 20.937 47.1 19.462H24.475V28.3H37.4C36.962 30.937 35.6 33.15 33.662 34.625V40.275H41.075C45.225 36.337 47.5 30.687 47.5 24.037Z" fill="#F7BBE1"></path><path d="M24.475 48C31.025 48 36.5 45.862 41.075 40.275H33.662C31.45 41.812 28.275 42.75 24.475 42.75C17.825 42.75 12.012 38.362 10.15 32.325H2.562V38.012C6.9 44.05 15.087 48 24.475 48Z" fill="#F7BBE1"></path><path d="M10.15 32.325C9.65 30.85 9.325 29.287 9.325 27.675C9.325 26.062 9.65 24.5 10.15 22.975V17.287H2.562C.925 20.25 0 23.85 0 27.675C0 31.5 0.925 35.1 2.562 38.012L10.15 32.325Z" fill="#F7BBE1"></path><path d="M24.475 9.6C27.9 9.6 31.212 10.762 33.662 13.012L41.15 5.525C36.5 1.5 31.025 0 24.475 0C15.087 0 6.9 3.95 2.562 9.987V17.287H10.15C12.012 11.25 17.825 9.6 24.475 9.6Z" fill="#F7BBE1"></path></svg>
                        Google
                    </button>
                    <button id="signup-facebook-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-gray-100 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5 text-[F7BBE1]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987H7.897v-2.89H10.438V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562v1.875h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"></path></svg>
                        Facebook
                    </button>
                </div>

                <p class="text-center text-sm text-gray-600 pt-10">
                    Hai gi√† un account? 
                    <button id="go-to-signin-link-2" class="font-bold txt-custom-pink">Login</button>
                </p>
            </div>
        </div>
        
        <div id="signin-view" class="app-view slide-from-bottom flex flex-col bg-custom-pink">
            <div class="p-8 pt-16 flex-shrink-0 bg-custom-pink">
                <h2 class="text-2xl font-bold text-gray-900"></h2>
            </div>

            <div class="flex-grow bg-white rounded-t-3xl shadow-2xl p-8 overflow-y-auto">
                <h3 class="text-3xl font-bold text-gray-900 mb-8">Sign In</h3>
                
                <form id="signin-form" class="space-y-5">
                    <div>
                        <label for="signin-email" class="block text-sm font-medium text-gray-600 mb-1">Email Address</label>
                        <input id="signin-email" type="email" placeholder="example@gmail.com" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div>
                        <label for="signin-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input id="signin-password" type="password" placeholder="example_1" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    
                    <button id="signin-btn" type="submit" class="w-full bg-purple-500 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transition-all duration-150 hover:bg-purple-600 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-purple-500/50 mt-4">
                        Sign In
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink mx-4 text-sm text-gray-400">Or sign in with</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="flex gap-4">
                    <button id="signin-google-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-gray-100 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M47.5 24.037C47.5 22.462 47.362 20.937 47.1 19.462H24.475V28.3H37.4C36.962 30.937 35.6 33.15 33.662 34.625V40.275H41.075C45.225 36.337 47.5 30.687 47.5 24.037Z" fill="F7BBE1"></path><path d="M24.475 48C31.025 48 36.5 45.862 41.075 40.275H33.662C31.45 41.812 28.275 42.75 24.475 42.75C17.825 42.75 12.012 38.362 10.15 32.325H2.562V38.012C6.9 44.05 15.087 48 24.475 48Z" fill="#F7BBE1"></path><path d="M10.15 32.325C9.65 30.85 9.325 29.287 9.325 27.675C9.325 26.062 9.65 24.5 10.15 22.975V17.287H2.562C.925 20.25 0 23.85 0 27.675C0 31.5 0.925 35.1 2.562 38.012L10.15 32.325Z" fill="F7BBE1"></path><path d="M24.475 9.6C27.9 9.6 31.212 10.762 33.662 13.012L41.15 5.525C36.5 1.5 31.025 0 24.475 0C15.087 0 6.9 3.95 2.562 9.987V17.287H10.15C12.012 11.25 17.825 9.6 24.475 9.6Z" fill="#EA4335"></path></svg>
                        Google
                    </button>
                    <button id="signin-facebook-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-gray-100 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5 text-[#F7BBE1]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987H7.897v-2.89H10.438V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562v1.875h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"></path></svg>
                        Facebook
                    </button>
                </div>

                <p class="text-center text-sm text-gray-600 mt-8">
                    Don't have an account? 
                    <button id="go-to-signup-link" class="font-bold text-purple-600 hover:underline">Registrati</button>
                </p>
            </div>
        </div>

        <div id="auth-view" class="app-view slide-from-bottom flex flex-col items-center justify-center p-8 bg-gray-50">
            
            <div class="max-w-md w-full text-center">
                <h1 class="text-5xl font-extrabold txt-custom-pink fontTitle mb-2">Lume</h1>
                <p class="text-md font-light text-gray-500 mb-10">Connettiti in modo sicuro e istantaneo.</p>
                
                <div class="p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
                    <button id="show-create-tab-button" class="w-full bg-custom-pink text-white font-semibold py-3 px-6 rounded-xl transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink mb-3">
                        Crea un Nuovo Codice
                    </button>
                    <button id="show-join-tab-button" class="w-full bg-transparent border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-gray-100 active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Unisciti con un Codice
                    </button>
                </div>

                <button id="signout-btn" class="mt-8 text-sm text-gray-500 hover:text-red-600 hover:underline">
                    Esci
                </button>
            </div>
        </div>

        <div id="home-view" class="app-view slide-from-bottom flex flex-col bg-custom-pink">
            <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between shadow-sm flex-shrink-0 z-10">
                <h1 class="text-2xl font-extrabold fontTitle txt-custom-pink">Lume</h1>
                <div class="flex items-center space-x-2">
                    <span id="partner-status" class="text-xs font-medium px-3 py-1 rounded-full text-pink-700 bg-pink-100 bordrs">...</span>
                </div>
            </header>
            
            <div class="flex-grow p-6 rounded-t-3xl shadow-2xl overflow-y-auto ">
                
                                <!-- SEZIONE EVENTI DINAMICA -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Eventi in Arrivo</h2>
                        <!-- NUOVO: Pulsante Aggiungi Evento -->
                        <button id="add-event-btn" class="bg-custom-pink text-gray-900 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-transform active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- NUOVO: Carosello Eventi -->
                    <div id="events-carousel" class="flex overflow-x-auto space-x-4 pb-4 no-scrollbar" style="scroll-snap-type: x mandatory;">
                        <!-- Gli eventi verranno iniettati qui da JS -->
                        <div class="p-5 text-center text-gray-500 w-full">
                            Caricamento eventi...
                        </div>
                    </div>
                </div>


                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Le Nostre Attivit√†</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Diario</h3>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Wrap Cards</h3>
                        </div>
                        
                        <div class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h.01M15 12h.01M10.5 16.5h.01M13.5 16.5h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Bacheca</h3>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Calendario</h3>
                        </div>
                    </div>
                </div>

            </div> <footer class="flex-shrink-0 bg-white border-t border-gray-200 shadow-inner flex justify-around p-3">
                <button class="flex flex-col items-center text-custom-pink p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">Home</span>
                </button>
                <button class="flex flex-col items-center text-gray-400 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="text-xs font-medium">Profilo</span>
                </button>
             </footer>
        </div>


        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-end justify-center z-50 transition-opacity duration-300 opacity-0">
            <div id="modal-sheet-content" class="modal-sheet w-full max-w-lg bg-white rounded-t-3xl shadow-2xl p-6 relative">
                
                <div class="handle-bar mb-6 cursor-pointer" id="close-modal-handle"></div>

                <div class="flex flex-col">
                    <div class="flex border-b border-gray-200 mb-8">
                        <button id="tab-create" class="flex-1 text-center py-3 text-sm font-medium border-b-2 transition-all" data-tab="create">Crea</button>
                        <button id="tab-join" class="flex-1 text-center py-3 text-sm font-medium border-b-2 transition-all" data-tab="join">Unisciti</button>
                    </div>

                    <div id="tab-content-create" class="tab-content">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">Il Tuo Codice</h2>
                        <p class="text-gray-500 mb-8 text-center">Condividi questo codice segreto per connetterti:</p>
                        
                        <div class="bg-gray-100 rounded-xl p-6 mb-8 text-center border border-gray-200">
                            <span id="code-display" class="text-6xl font-extrabold tracking-widest text-custom-pink">...</span>
                        </div>
                        
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-3 h-3 bg-custom-pink rounded-full animate-pulse"></div>
                            <div class="w-3 h-3 bg-custom-pink rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                            <div class="w-3 h-3 bg-custom-pink rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                        </div>
                        <p class="text-gray-500 mt-4 text-sm text-center">In attesa che un partner si unisca...</p>
                    </div>

                    <div id="tab-content-join" class="tab-content hidden">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">Inserisci il Codice</h2>
                        <p class="text-gray-500 mb-6 text-center">Digita il codice di 6 cifre fornito dal tuo partner.</p>
                        
                        <input id="code-input" type="number" maxlength="6" class="w-full text-center text-3xl font-bold p-4 rounded-xl border border-gray-300 bg-gray-50 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-pink focus:border-pink transition-colors" placeholder="000000">
                        
                        <button id="join-button" class="w-full bg-pink text-pink font-semibold py-4 px-6 rounded-xl transition-all duration-150 bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink mt-8">
                            Connettiti
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center transform transition-all scale-95 border border-gray-200">
                <p id="modal-text" class="text-md text-gray-800 mb-6"></p>
                <button id="modal-close-button" class="w-full bg-custom-pink text-white font-semibold py-3 px-6 rounded-lg transition-all hover:bg-custom-pinkfocus:outline-none focus:ring-2 focus:ring-pink">
                    OK
                </button>
            </div>
        </div>
        


        <!-- NUOVO: MODALE AGGIUNGI EVENTO -->
        <div id="add-event-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div id="add-event-modal-content" class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-95 border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Nuovo Evento</h3>
                    <button id="close-event-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <form id="add-event-form" class="space-y-4">
                    <div>
                        <label for="event-title" class="block text-sm font-medium text-gray-600 mb-1">Titolo</label>
                        <input id="event-title" type="text" placeholder="es. Cena fuori" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label for="event-date" class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                            <input id="event-date" type="date" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                        </div>
                        <div class="flex-1">
                            <label for="event-time" class="block text-sm font-medium text-gray-600 mb-1">Ora</label>
                            <input id="event-time" type="time" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                        </div>
                    </div>
                    <div>
                        <label for="event-description" class="block text-sm font-medium text-gray-600 mb-1">Descrizione (opzionale)</label>
                        <textarea id="event-description" rows="2" placeholder="Ricordati di prenotare!" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm"></textarea>
                    </div>
                    
                    <button id="save-event-btn" type="submit" class="w-full bg-custom-pink text-gray-900 font-semibold py-4 px-6 rounded-xl shadow-lg transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink/50 mt-4">
                        Salva Evento
                    </button>
                </form>
            </div>
        </div>


    </div> 
    
    

    </div> <script type="module">
        // Importa funzioni Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword, // NUOVO
            signInWithEmailAndPassword,   // NUOVO
            signInWithPopup,              // NUOVO
            GoogleAuthProvider,           // NUOVO
            FacebookAuthProvider,         // NUOVO
            signOut                       // NUOVO
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            query, 
            serverTimestamp, 
            setLogLevel,
            limit,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali (dall'ambiente Canvas) ---
        
        // Fallback configuration if canvas environment variables are not set
        const userFallbackConfig = {
            apiKey: "AIzaSyDHALYDfyXQIiEzc8IfH7aKjiyXNAWX4_0",
            authDomain: "amicae-99c7b.firebaseapp.com",
            projectId: "amicae-99c7b",
            storageBucket: "amicae-99c7b.firebasestorage.app",
            messagingSenderId: "379845487963",
            appId: "1:379845487963:web:e73dc5c970e627676c7e7e",
            measurementId: "G-LYV92RTCX7"
        };

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : JSON.stringify(userFallbackConfig)); 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inizializzazione Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug');
        } catch (e) {
            console.error("Errore inizializzazione Firebase:", e);
            document.getElementById('loading-view').innerHTML = '<h2 class="text-xl font-semibold text-red-600">Errore di configurazione.</h2>';
        }

        // Stato dell'applicazione
        let userId = null;
        let pairingCode = null;
        let partnerId = null;
        let pairingListenerUnsubscribe = null;
                
        
        let isAuthReady = false; 

        // let messagesListenerUnsubscribe = null; // RIMOSSO
        
        // Riferimenti DOM
        const views = {
            loading: document.getElementById('loading-view'),
            welcome: document.getElementById('welcome-view'), // NUOVO
            signup: document.getElementById('signup-view'),   // NUOVO
            signin: document.getElementById('signin-view'),   // NUOVO
            auth: document.getElementById('auth-view'),
            home: document.getElementById('home-view') // SOSTITUITO main con home
        };
        const modal = document.getElementById('auth-modal');
        const modalSheetContent = document.getElementById('modal-sheet-content');
        const codeDisplay = document.getElementById('code-display');
        const codeInput = document.getElementById('code-input');
        // Riferimenti chat rimossi
        // const chatMessages = document.getElementById('chat-messages');
        // const chatInput = document.getElementById('chat-input');
        // const sendButton = document.getElementById('send-button');
        const partnerStatus = document.getElementById('partner-status'); // MANTENUTO
          // Modale Messaggi
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalContent = messageModal.querySelector('div'); 

// NUOVO: Riferimenti Modale Eventi
        const addEventModal = document.getElementById('add-event-modal');
        const addEventModalContent = document.getElementById('add-event-modal-content');
        const addEventBtn = document.getElementById('add-event-btn');
        const closeEventModalBtn = document.getElementById('close-event-modal-btn');
        const addEventForm = document.getElementById('add-event-form');
        const eventsCarousel = document.getElementById('events-carousel');
        // --- Funzioni di Utility ---

        /**
         * Mostra una vista principale con animazione
         * @param {string} viewId 'loading', 'auth', etc.
         */
        function showView(viewId) {
            Object.keys(views).forEach(key => {
                const view = views[key];
                if (key === viewId) {
                    view.classList.add('visible');
                    view.classList.remove('slide-from-bottom');
                } else {
                    view.classList.remove('visible');
                    // Reimposta la posizione di partenza
                    if (!view.classList.contains('slide-from-bottom')) {
                        view.classList.add('slide-from-bottom');
                    }
                }
            });
        }

        /**
         * Mostra un messaggio modale (sostituto di alert)
         * @param {string} message Testo da mostrare
         */
        function showMessage(message) {
            // Sostituisci i codici di errore di Firebase con messaggi amichevoli
            let friendlyMessage = message;
            if (message.includes("auth/email-already-in-use")) {
                friendlyMessage = "Questo indirizzo email √® gi√† in uso. Prova ad accedere.";
            } else if (message.includes("auth/wrong-password") || message.includes("auth/user-not-found") || message.includes("auth/invalid-credential")) {
                friendlyMessage = "Email o password non corretti. Riprova.";
            } else if (message.includes("auth/weak-password")) {
                friendlyMessage = "La password deve essere di almeno 6 caratteri.";
            } else if (message.includes("auth/invalid-email")) {
                friendlyMessage = "L'indirizzo email non √® valido.";
            } else if (message.includes("auth/popup-closed-by-user")) {
                friendlyMessage = "Accesso annullato.";
            }
            
            modalText.textContent = friendlyMessage;
            messageModal.classList.remove('hidden');
            setTimeout(() => {
                messageModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        // Evento chiusura modale messaggi
        document.getElementById('modal-close-button').addEventListener('click', () => {
            messageModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => messageModal.classList.add('hidden'), 300);
        });

        // --- Logica Modale Auth (Sheet) ---
        // (Questa √® la logica per il MODALE di pairing, non per il login)
        
        function openAuthModal(tab) {
            if (!isAuthReady || !userId) {
                showMessage("Devi essere connesso per usare questa funzione.");
                return;
            }
            modal.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalSheetContent.classList.add('open');
            }, 10);
            switchTab(tab);
        }

        function closeAuthModal() {
            modalSheetContent.classList.remove('open');
            setTimeout(() => {
                modal.classList.add('opacity-0');
                modal.classList.add('hidden');
            }, 300);
            if (pairingListenerUnsubscribe) {
                pairingListenerUnsubscribe();
                pairingListenerUnsubscribe = null;
                codeDisplay.textContent = '...';
            }
        }
        document.getElementById('show-create-tab-button').addEventListener('click', () => openAuthModal('create'));
        document.getElementById('show-join-tab-button').addEventListener('click', () => openAuthModal('join'));
        document.getElementById('close-modal-handle').addEventListener('click', closeAuthModal);
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'auth-modal') closeAuthModal();
        });

        const tabContents = { create: document.getElementById('tab-content-create'), join: document.getElementById('tab-content-join') };
        const tabButtons = { create: document.getElementById('tab-create'), join: document.getElementById('tab-join') };
        
        function switchTab(tabId) {
            Object.keys(tabContents).forEach(key => {
                if (key === tabId) {
                    tabContents[key].classList.remove('hidden');
                    tabButtons[key].classList.add('text-custom-pink', 'border-pink');
                } else {
                    tabContents[key].classList.add('hidden');
                    tabButtons[key].classList.remove('text-custom-pink', 'border-pink');
                    tabButtons[key].classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300');
                }
            });
            if (tabId === 'join') codeInput.value = '';
            if (tabId === 'join' && pairingListenerUnsubscribe) {
                pairingListenerUnsubscribe();
                pairingListenerUnsubscribe = null;
                codeDisplay.textContent = '...';
            }
            if (tabId === 'create' && !pairingListenerUnsubscribe) {
                handleCreateConnection();
            }
        }

        tabButtons.create.addEventListener('click', () => switchTab('create'));
        tabButtons.join.addEventListener('click', () => switchTab('join'));

        // --- NUOVA Logica di Autenticazione ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Utente autenticato:", user.uid);
                userId = user.uid;
                isAuthReady = true;
                // Piccolo ritardo per mostrare l'animazione di caricamento
                // L'utente √® loggato, mostra la vista di pairing
                setTimeout(() => showView('auth'), 500); 
            } else {
                console.log("Nessun utente, mostro la welcome view.");
                userId = null;
                isAuthReady = true; // L'app √® pronta per il login
                // Piccolo ritardo per mostrare l'animazione di caricamento
                // Nessun utente, mostra la vista di benvenuto
                setTimeout(() => showView('welcome'), 500); 
            }
        });

        // Tenta il login con token custom se esiste (per ambiente Canvas)
        (async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Nessun token iniziale, in attesa di login manuale.");
                }
            } catch (error) {
                console.error("Errore con token iniziale:", error);
                // onAuthStateChanged gestir√† e mostrer√† 'welcome-view'
            }
        })();

        // --- NUOVI Listener per le viste di Login/Registrazione ---

        // Navigazione tra le viste
        document.getElementById('get-started-btn').addEventListener('click', () => showView('signup'));
        document.getElementById('go-to-signin-link').addEventListener('click', () => showView('signin'));
        document.getElementById('go-to-signin-link-2').addEventListener('click', () => showView('signin'));
        document.getElementById('go-to-signup-link').addEventListener('click', () => showView('signup'));

        // Gestione Form
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged gestir√† la transizione
            } catch (error) {
                showMessage(error.message);
            }
        });

        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged gestir√† la transizione
            } catch (error) {
                showMessage(error.message);
            }
        });

        // Gestione Login Social
        const handleSocialLogin = async (providerName) => {
            const provider = providerName === 'google' 
                ? new GoogleAuthProvider() 
                : new FacebookAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged gestir√† la transizione
            } catch (error) {
                showMessage(error.message);
            }
        };

        document.getElementById('signup-google-btn').addEventListener('click', () => handleSocialLogin('google'));
        document.getElementById('signup-facebook-btn').addEventListener('click', () => handleSocialLogin('facebook'));
        document.getElementById('signin-google-btn').addEventListener('click', () => handleSocialLogin('google'));
        document.getElementById('signin-facebook-btn').addEventListener('click', () => handleSocialLogin('facebook'));

        // Gestione Sign Out
        document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged gestir√† la transizione a 'welcome-view'
            } catch (error) {
                showMessage(error.message);
            }
        });


        // --- Logica di Connessione (Pairing) ---
        // (Questa logica √® quasi invariata, ma ora dipende da un userId non anonimo)

        async function handleCreateConnection() {
            if (!userId) return;
            
            if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();

            const newCode = Math.floor(100000 + Math.random() * 900000).toString();
            pairingCode = newCode;
            
            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);
            
            try {
                await setDoc(pairDocRef, {
                    initiatorId: userId,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                codeDisplay.textContent = pairingCode;
                listenForPairing(pairDocRef);
            } catch (error) {
                console.error("Errore creazione connessione:", error);
                showMessage("Impossibile creare la connessione. Riprova.");
                closeAuthModal();
            }
        }

        document.getElementById('join-button').addEventListener('click', async () => {
            if (!userId) return;

            const code = codeInput.value.trim();
            if (code.length !== 6) {
                showMessage("Il codice deve essere di 6 cifre.");
                return;
            }

            pairingCode = code;
            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);

            try {
                const docSnap = await getDoc(pairDocRef);

                if (!docSnap.exists() || docSnap.data().status !== 'pending') {
                    showMessage("Codice non valido o gi√† utilizzato.");
                    return;
                }

                await updateDoc(pairDocRef, {
                    joinerId: userId,
                    status: 'connected'
                });

                partnerId = docSnap.data().initiatorId;
                closeAuthModal();
                showMessage("Connesso! Benvenuti."); // Messaggio aggiornato
                startHomeView(); // NOME FUNZIONE AGGIORNATO

            } catch (error) {
                console.error("Errore unione connessione:", error);
                showMessage("Impossibile unirsi. Controlla il codice.");
            }
        });
        
                document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                // ... (codice esistente per resettare state)
                if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();
                if (eventsListenerUnsubscribe) eventsListenerUnsubscribe(); // <-- AGGIUNGI QUESTA RIGA
                pairingListenerUnsubscribe = null;
                eventsListenerUnsubscribe = null; // <-- AGGIUNGI QUESTA RIGA
            } catch (error) {
                showMessage(error.message);
            }
        });


        function listenForPairing(docRef) {
            pairingListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().status === 'connected') {
                    partnerId = docSnap.data().joinerId;
                    if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();
                    closeAuthModal();
                    showMessage("Partner connesso! Benvenuti."); // Messaggio aggiornato
                    startHomeView(); // NOME FUNZIONE AGGIORNATO
                }
            }, (error) => {
                console.error("Errore ascolto pairing:", error);
                showMessage("Errore di connessione. Riprova.");
                closeAuthModal();
            });
        }
        
        // --- Logica App Principale (Home) ---

        function startHomeView() {
            showView('home');
            // Aggiorna lo status nell'header della nuova home view
            partnerStatus.textContent = `Connesso con: ${partnerId.substring(0, 6)}...`; 
            // Aggiorna i colori dello status per abbinarli al tema
            partnerStatus.classList.remove('text-green-700', 'bg-green-100'); // Rimuove vecchie classi (se presenti)
            partnerStatus.classList.add('text-pink-700', 'bg-pink-100'); // Aggiunge nuove classi rosa
        }

        // (Tutta la logica della chat √® stata rimossa)
        
        
                // --- NUOVA: Logica Eventi ---

        /**
         * Formatta una stringa data ISO (es. 2025-12-20T20:30) in un formato leggibile.
         * @param {string} isoString
         * @returns {string} Data formattata (es. "ven 20 dic, 20:30")
         */
        function formatEventDate(isoString) {
            if (!isoString) return "Data non specificata";
            try {
                const date = new Date(isoString);
                const options = {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                let formatted = new Intl.DateTimeFormat('it-IT', options).format(date);
                // Pulisce la formattazione (es. rimuove "alle")
                formatted = formatted.replace('alle', '');
                return formatted;
            } catch (e) {
                console.error("Errore formattazione data:", e);
                return "Data non valida";
            }
            listenForEvents();
        }
        
        /**
         * Si mette in ascolto degli eventi condivisi sulla connessione.
         */
        function listenForEvents() {
            if (!pairingCode) return;
            if (eventsListenerUnsubscribe) eventsListenerUnsubscribe();

            const eventsCollectionRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'events');
            // Ordina per data evento, dal pi√π vicino al pi√π lontano
            const q = query(eventsCollectionRef, orderBy("eventDate", "asc"));

            eventsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                renderEvents(snapshot.docs);
            }, (error) => {
                console.error("Errore ascolto eventi:", error);
                eventsCarousel.innerHTML = '<div class="p-5 text-center text-red-500 w-full">Errore nel caricare gli eventi.</div>';
            });
        }

        /**
         * Renderizza la lista di eventi nel carosello.
         * @param {Array} docs Array di documenti (eventi) da Firestore.
         */
        function renderEvents(docs) {
            eventsCarousel.innerHTML = ''; // Pulisce il carosello

            if (docs.length === 0) {
                eventsCarousel.innerHTML = `
                    <div class="flex-shrink-0 w-full text-center p-5">
                        <p class="text-gray-500">Nessun evento in programma.</p>
                        <p class="text-gray-400 text-sm">Aggiungine uno con il tasto '+'!</p>
                    </div>
                `;
                return;
            }

            // Filtra eventi passati (opzionale, ma utile)
                        // Filtra eventi passati (considerando solo la data odierna)
            const now = new Date();
            // Resetta l'ora corrente a mezzanotte (00:00:00) per includere tutti gli eventi di oggi
            now.setHours(0, 0, 0, 0); 
            
            // Filtra e ordina gli eventi a partire da oggi
            const upcomingDocs = docs.filter(doc => new Date(doc.data().eventDate) >= now);


            if (upcomingDocs.length === 0) {
                eventsCarousel.innerHTML = `
                    <div class="flex-shrink-0 w-full text-center p-5">
                        <p class="text-gray-500">Nessun evento futuro.</p>
                         <p class="text-gray-400 text-sm">Aggiungine uno nuovo!</p>
                    </div>
                `;
                 return;
            }

            upcomingDocs.forEach(doc => {
                const event = doc.data();
                const eventDate = new Date(event.eventDate);

                // Formattazione per il "datario"
                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('it-IT', { month: 'short' }).toUpperCase().replace('.', '');

                // Formattazione per la data leggibile
                const fullFormattedDate = formatEventDate(event.eventDate);


                const eventCardHTML = `
                    <div class="flex-shrink-0 w-4/5 max-w-xs bg-white p-5 rounded-2xl shadow-lg border border-gray-100" style="scroll-snap-align: start;">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-bold text-lg text-gray-900 truncate">${event.title}</h3>
                                <p class="text-sm text-custom-pink font-medium">${fullFormattedDate}</p>
                            </div>
                            <div class="text-center flex-shrink-0 ml-4">
                                <span class="block text-3xl font-bold text-custom-pink">${day}</span>
                                <span class="block text-xs font-medium text-gray-500 uppercase">${month}</span>
                            </div>
                        </div>
                        ${event.description ? `<p class="text-sm text-gray-600">${event.description}</p>` : ''}
                    </div>
                `;
                eventsCarousel.innerHTML += eventCardHTML;
            });
        }

        // --- Listener Modale Eventi ---
        
        function openEventModal() {
            addEventForm.reset(); // Pulisce il form
            addEventModal.classList.remove('hidden');
            setTimeout(() => {
                addEventModal.classList.remove('opacity-0');
                addEventModalContent.classList.remove('scale-95');
            }, 10);
        }
        
        function closeEventModal() {
            addEventModal.classList.add('opacity-0');
            addEventModalContent.classList.add('scale-95');
            setTimeout(() => addEventModal.classList.add('hidden'), 300);
        }

        addEventBtn.addEventListener('click', openEventModal);
        closeEventModalBtn.addEventListener('click', closeEventModal);
        
        // Clicca fuori per chiudere (solo per modale eventi)
        addEventModal.addEventListener('click', (e) => {
            if (e.target.id === 'add-event-modal') closeEventModal();
        });


        // Gestione salvataggio evento
        addEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!pairingCode) {
                showMessage("Errore: Connessione non trovata.");
                return;
            }

            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const description = document.getElementById('event-description').value;
            
            // Combina data e ora in una stringa ISO 8601 valida (es: 2025-12-20T14:30)
            const eventDateISO = `${date}T${time}`;

            // Validazione base
            if (!title || !date || !time) {
                showMessage("Titolo, data e ora sono obbligatori.");
                return;
            }
            if (new Date(eventDateISO) < new Date()) {
                showMessage("Non puoi aggiungere un evento nel passato.");
                return;
            }

            try {
                // Salva l'evento nella sottocollezione del pairing
                const eventsCollectionRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'events');
                
                await addDoc(eventsCollectionRef, {
                    title: title,
                    eventDate: eventDateISO,
                    description: description,
                    createdBy: userId,
                    createdAt: serverTimestamp()
                });

                showMessage("Evento aggiunto con successo!");
                closeEventModal();

            } catch (error) {
                console.error("Errore salvataggio evento: ", error);
                showMessage("Impossibile salvare l'evento. Riprova.");
            }
        });


    </script>
</body>
</html>