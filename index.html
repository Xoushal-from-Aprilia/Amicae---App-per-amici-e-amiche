<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amicae - Connessi</title>
    <!-- Caricamento Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Caricamento Google Font "Inter" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Stile di base e font */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animazione per il caricamento */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        /* Stile per i contenitori delle viste per le animazioni */
        .view {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            will-change: opacity, transform;
        }

        /* Nasconde la scrollbar del contenitore chat */
        #chat-messages::-webkit-scrollbar {
            display: none;
        }
        #chat-messages {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-rose-50 flex items-center justify-center min-h-screen p-4">

    <!-- Contenitore principale dell'app -->
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden" style="height: 90vh; max-height: 700px;">
        <div class="h-full flex flex-col">

            <!-- VISTA: Caricamento Iniziale -->
            <div id="loading-view" class="view flex flex-col items-center justify-center h-full p-8 text-center">
                <svg class="animate-spin h-10 w-10 text-rose-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h2 class="text-xl font-semibold text-gray-700">Connessione in corso...</h2>
                <p class="text-gray-500">Attendere prego.</p>
            </div>

            <!-- VISTA: Autenticazione e Connessione -->
            <div id="auth-view" class="view hidden h-full opacity-0 scale-95">
                <!-- Sottovista: Home (Crea o Unisciti) -->
                <div id="auth-home" class="flex flex-col justify-center h-full p-8 text-center">
                    <h1 class="text-4xl font-bold text-rose-800 mb-4">Amicae</h1>
                    <p class="text-lg text-gray-600 mb-10">Connettiti con la tua persona speciale.</p>
                    <div class="flex flex-col gap-4">
                        <button id="show-create-button" class="w-full bg-rose-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-50">
                            Crea una connessione
                        </button>
                        <button id="show-join-button" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                            Unisciti a una connessione
                        </button>
                    </div>
                </div>

                <!-- Sottovista: Crea Connessione -->
                <div id="auth-create" class="hidden flex-col justify-center h-full p-8 text-center">
                    <button id="back-to-home-1" class="absolute top-4 left-4 text-gray-500 hover:text-rose-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Il tuo codice</h2>
                    <p class="text-gray-600 mb-6">Condividi questo codice con il tuo partner:</p>
                    <div class="bg-gray-100 rounded-lg p-4 mb-6">
                        <span id="code-display" class="text-5xl font-bold text-rose-500 tracking-widest">......</span>
                    </div>
                    <div class="flex items-center justify-center space-x-2">
                        <div class="loader-dots w-3 h-3 bg-gray-400 rounded-full animate-pulse"></div>
                        <div class="loader-dots w-3 h-3 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                        <div class="loader-dots w-3 h-3 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    </div>
                    <p class="text-gray-500 mt-4">In attesa del partner...</p>
                </div>

                <!-- Sottovista: Unisciti a Connessione -->
                <div id="auth-join" class="hidden flex-col justify-center h-full p-8 text-center">
                    <button id="back-to-home-2" class="absolute top-4 left-4 text-gray-500 hover:text-rose-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Inserisci il codice</h2>
                    <p class="text-gray-600 mb-6">Chiedi al tuo partner il codice di 6 cifre.</p>
                    <input id="code-input" type="number" maxlength="6" class="w-full text-center text-3xl font-semibold p-4 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-rose-500 focus:border-rose-500 transition-colors" placeholder="123456">
                    <button id="join-button" class="w-full bg-rose-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-50 mt-6">
                        Connettiti
                    </button>
                </div>
            </div>

            <!-- VISTA: App Principale (Chat) -->
            <div id="main-app-view" class="view hidden h-full opacity-0 scale-95 flex-col">
                <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between shadow-sm flex-shrink-0">
                    <h1 class="text-xl font-bold text-rose-800">Connessi</h1>
                    <!-- Aggiungi qui ID partner o stato -->
                    <span class="text-xs text-green-500 font-semibold">Online</span>
                </header>
                
                <!-- Contenitore messaggi chat -->
                <div id="chat-messages" class="flex-grow p-4 flex flex-col gap-3 overflow-y-auto">
                    <!-- I messaggi della chat verranno inseriti qui da JS -->
                </div>
                
                <!-- Input invio messaggio -->
                <footer class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" class="flex-grow w-full px-4 py-3 rounded-full border-2 border-gray-200 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent" placeholder="Scrivi un messaggio...">
                        <button id="send-button" class="bg-rose-500 text-white rounded-full p-3 flex-shrink-0 shadow-md transition-transform transform hover:scale-105 hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" transform="rotate(90 12 12)" />
                            </svg>
                        </button>
                    </div>
                </footer>
            </div>

        </div>
    </div>

    <!-- Modale per messaggi/errori -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <p id="modal-text" class="text-lg text-gray-700 mb-4"></p>
            <button id="modal-close-button" class="bg-rose-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-50">
                OK
            </button>
        </div>
    </div>


    <!-- Script Firebase e Logica App -->
    <script type="module">
        // Importa funzioni Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            query, 
            serverTimestamp, 
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali (dall'ambiente Canvas) ---
        
        // Definisci la configurazione di fallback fornita dall'utente
        const userFallbackConfig = {
            apiKey: "AIzaSyDHALYDfyXQIiEzc8IfH7aKjiyXNAWX4_0",
            authDomain: "amicae-99c7b.firebaseapp.com",
            projectId: "amicae-99c7b",
            storageBucket: "amicae-99c7b.firebasestorage.app",
            messagingSenderId: "379845487963",
            appId: "1:379845487963:web:e73dc5c970e627676c7e7e",
            measurementId: "G-LYV92RTCX7"
        };

        // Prova a usare la configurazione dell'ambiente Canvas, altrimenti usa il fallback
        // Questo è il codice AGGIORNATO come da tua richiesta
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : JSON.stringify(userFallbackConfig)); 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inizializzazione Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug'); // Abilita log per debug
        } catch (e) {
            console.error("Errore inizializzazione Firebase:", e);
            document.getElementById('loading-view').innerHTML = '<h2 class="text-xl font-semibold text-red-700">Errore di configurazione.</h2>';
        }

        // Stato dell'applicazione
        let userId = null;
        let pairingCode = null;
        let partnerId = null;
        let pairingListenerUnsubscribe = null;
        let messagesListenerUnsubscribe = null;

        // Riferimenti DOM
        const views = {
            loading: document.getElementById('loading-view'),
            auth: document.getElementById('auth-view'),
            main: document.getElementById('main-app-view')
        };
        const authViews = {
            home: document.getElementById('auth-home'),
            create: document.getElementById('auth-create'),
            join: document.getElementById('auth-join')
        };

        const codeDisplay = document.getElementById('code-display');
        const codeInput = document.getElementById('code-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');

        const modal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');

        // --- Funzioni di Utility ---

        /**
         * Mostra una vista specifica con animazione
         * @param {string} viewId 'loading', 'auth', or 'main'
         */
        function showView(viewId) {
            Object.values(views).forEach(view => {
                view.classList.add('hidden', 'opacity-0', 'scale-95');
            });
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
                // Un piccolo ritardo per permettere al CSS di applicare 'hidden' prima di animare
                setTimeout(() => {
                    views[viewId].classList.remove('opacity-0', 'scale-95');
                }, 50);
            }
        }

        /**
         * Mostra una sottovista di autenticazione
         * @param {string} authViewId 'home', 'create', or 'join'
         */
        function showAuthView(authViewId) {
            Object.values(authViews).forEach(view => view.classList.add('hidden'));
            if (authViews[authViewId]) {
                authViews[authViewId].classList.remove('hidden');
            }
        }

        /**
         * Mostra un messaggio modale
         * @param {string} message Testo da mostrare
         */
        function showMessage(message) {
            modalText.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        // Evento chiusura modale
        document.getElementById('modal-close-button').addEventListener('click', () => {
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        });

        // --- Logica di Autenticazione ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Utente autenticato:", user.uid);
                userId = user.uid;
                // Controlla se l'utente è già connesso a una sessione
                // (Logica da implementare se si vuole persistenza tra ricaricamenti)
                showView('auth');
                showAuthView('home');
            } else {
                console.log("Nessun utente, tentativo di login...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Errore di autenticazione:", error);
                    showMessage("Impossibile autenticarsi. Riprova più tardi.");
                }
            }
        });

        // --- Logica di Navigazione Auth ---

        document.getElementById('show-create-button').addEventListener('click', handleCreateConnection);
        document.getElementById('show-join-button').addEventListener('click', () => showAuthView('join'));
        document.getElementById('back-to-home-1').addEventListener('click', () => showAuthView('home'));
        document.getElementById('back-to-home-2').addEventListener('click', () => showAuthView('home'));

        // --- Logica di Connessione (Pairing) ---

        /**
         * Genera un codice e crea un documento di pairing
         */
        async function handleCreateConnection() {
            if (!userId) {
                showMessage("Errore: Utente non autenticato.");
                return;
            }
            
            // Pulisce listener precedenti
            if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();

            const newCode = Math.floor(100000 + Math.random() * 900000).toString();
            pairingCode = newCode;
            
            // Path pubblico per il pairing
            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);
            
            try {
                await setDoc(pairDocRef, {
                    initiatorId: userId,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                
                codeDisplay.textContent = pairingCode;
                showAuthView('create');
                
                // Si mette in ascolto del documento per sapere quando il partner si connette
                listenForPairing(pairDocRef);

            } catch (error) {
                console.error("Errore creazione connessione:", error);
                showMessage("Impossibile creare la connessione. Riprova.");
                showAuthView('home');
            }
        }

        /**
         * Si unisce a una connessione esistente
         */
        document.getElementById('join-button').addEventListener('click', async () => {
            if (!userId) {
                showMessage("Errore: Utente non autenticato.");
                return;
            }

            const code = codeInput.value.trim();
            if (code.length !== 6) {
                showMessage("Il codice deve essere di 6 cifre.");
                return;
            }

            pairingCode = code;
            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);

            try {
                const docSnap = await getDoc(pairDocRef);

                if (!docSnap.exists() || docSnap.data().status !== 'pending') {
                    showMessage("Codice non valido o già utilizzato.");
                    return;
                }

                // Trovato! Aggiorna il documento e imposta lo stato a "connesso"
                await updateDoc(pairDocRef, {
                    joinerId: userId,
                    status: 'connected'
                });

              partnerId = docSnap.data().initiatorId;
                showMessage("Connesso con successo!");
                startMainApp();

            } catch (error) {
                console.error("Errore unione connessione:", error);
                showMessage("Impossibile unirsi alla connessione. Riprova.");
            }
        });

        /**
         * Ascolta i cambiamenti sul documento di pairing (per l'iniziatore)
         * @param {DocumentReference} docRef Riferimento al documento di pairing
         */
        function listenForPairing(docRef) {
            pairingListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().status === 'connected') {
                    partnerId = docSnap.data().joinerId;
                    
                    // Ferma l'ascolto
                    if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();
                    
                    showMessage("Partner connesso!");
                    startMainApp();
                }
            });
        }


        // --- Logica App Principale (Chat) ---

        /**
         * Avvia l'app principale e l'ascolto dei messaggi
         */
        function startMainApp() {
            showView('main');
            listenForMessages();
        }

        /**
         * Ascolta i nuovi messaggi nella chat condivisa
         */
        function listenForMessages() {
            if (messagesListenerUnsubscribe) messagesListenerUnsubscribe(); // Pulisce listener vecchi

            // Path condiviso per la chat, basato sul codice di pairing
            const messagesRef = collection(db, 'artifacts', appId, 'public/data/shared', pairingCode, 'messages');
            
            // NOTA: Come da istruzioni, evito orderBy() per evitare la necessità di indici.
            // Ordinerò i messaggi in locale.
            const q = query(messagesRef);

            messagesListenerUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push(doc.data());
                });

                // Ordina i messaggi in base al timestamp (in locale)
                messages.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeA - timeB;
                });

                renderMessages(messages);

            }, (error) => {
                console.error("Errore ascolto messaggi:", error);
                showMessage("Errore di connessione alla chat.");
            });
        }

        /**
         * Renderizza i messaggi nella UI
         * @param {Array<Object>} messages Array di oggetti messaggio
         */
        function renderMessages(messages) {
            chatMessages.innerHTML = ''; // Pulisce la chat
            
            messages.forEach(msg => {
                const isSender = msg.senderId === userId;
                
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('flex', 'w-full');
                
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('p-3', 'rounded-xl', 'max-w-xs', 'shadow-sm');
                messageBubble.textContent = msg.text;

                if (isSender) {
                    messageWrapper.classList.add('justify-end');
                    messageBubble.classList.add('bg-rose-500', 'text-white');
                } else {
                    messageWrapper.classList.add('justify-start');
                    messageBubble.classList.add('bg-gray-200', 'text-gray-900');
                }
                
                messageWrapper.appendChild(messageBubble);
                chatMessages.appendChild(messageWrapper);
            });

            // Scrolla automaticamente alla fine
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Invia un messaggio
         */
        async function sendMessage() {
            const text = chatInput.value.trim();
            if (text === '' || !userId || !pairingCode) return;

            const messagesRef = collection(db, 'artifacts', appId, 'public/data/shared', pairingCode, 'messages');

            try {
                await addDoc(messagesRef, {
                    text: text,
                    senderId: userId,
                    timestamp: serverTimestamp()
                });
                chatInput.value = ''; // Pulisce l'input
            } catch (error) {
                console.error("Errore invio messaggio:", error);
                showMessage("Impossibile inviare il messaggio.");
            }
        }
        
        // Eventi per l'invio
        document.getElementById('send-button').addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

    </script>
</body>
</html>
     