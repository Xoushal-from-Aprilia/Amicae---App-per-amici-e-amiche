<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lume - Connessioni</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Belanosima:wght@400;600;700&family=Covered+By+Your+Grace&family=Dela+Gothic+One&family=Leckerli+One&family=Moirai+One&family=Pixelify+Sans:wght@587&family=Qahiri&family=Righteous&family=Rochester&family=Sigmar&family=Staatliches&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Stile di base e font */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            /* L'overflow √® gestito dai contenitori */
            background-color: #f9fafb; 
            color: #1f2937;
        }
/* Colori personalizzati estratti dal mockup */
.bg-custom-light-purple {
    background-color: #F3E8FF;
}

        /* Nasconde la scrollbar */
        .app-view::-webkit-scrollbar { display: none; }
        .app-view { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* NUOVO: Nasconde scrollbar per carosello eventi */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }


.rochester-regular {
  font-family: "Rochester", cursive;
  font-weight: 400;
  font-style: normal;
}


.fontTitle{
    font-family: "Rochester", cursive;
}

/* Colore uniforme per i pulsanti: #F7BBE1 */
.bg-custom-pink { 
    background-color: #F7BBE1;
    color: #333; /* Aggiungi un colore del testo scuro per il contrasto */
    border-color: #F7BBE1; /* Imposta il bordo con lo stesso colore */
}
.bg-custom-pink:hover {
     opacity: 0.9;
}

.txt-custom-pink { 
    
    color: #F7BBE1; /* Aggiungi un colore del testo scuro per il contrasto */

}

/* Colori specifici per la UI (es. status, icone) */
.text-custom-pink {
    color: #F7BBE1;
}
.bg-pink-100 {
    background-color: #FCE7F3; /* Un rosa pallido per sfondi */
}
.text-pink-700 {
    color: #BE185D; /* Un rosa scuro per il testo */
}
.border-pink {
    border-color: #F7BBE1;
}
.ring-pink {
    --tw-ring-color: #F7BBE1;
}


        /* Contenitore principale delle viste (App Stack) */
        .app-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Aggiunge overscroll-y-auto per lo scrolling interno se necessario */
            overflow-y: auto; 
            transition: transform 0.35s ease-out, opacity 0.35s;
            will-change: transform, opacity;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .app-view.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            z-index: 20;
        }

        .app-view.slide-from-bottom { transform: translateY(100%); }

        /* Stile Modale "Sheet" (minimalista) */
        .modal-sheet {
            transition: transform 0.3s ease-out;
            transform: translateY(100%);
        }
        .modal-sheet.open {
            transform: translateY(0);
        }

        /* Nasconde la scrollbar */
        .app-view::-webkit-scrollbar { display: none; }
        .app-view { -ms-overflow-style: none; scrollbar-width: none; }

.bordrs {
  border-radius: 25px;
    background-color: #fff;        
}

        /* Icona di trascinamento nel Modale (Minimal) */
        .handle-bar {
            width: 40px;
            height: 4px;
            background-color: #ccc;
            border-radius: 2px;
            margin: 0 auto 1rem auto;
        }

        /* --- NUOVI STILI DIARIO --- */
        /* Stile per i tab del diario */
        .diary-tab {
            transition: all 0.2s ease-in-out;
        }
        .diary-tab.active {
            border-color: #F7BBE1; /* border-pink */
            color: #F7BBE1; /* text-custom-pink */
            background-color: #fdf2f8; /* bg-pink-50 (un po' pi√π scuro) */
        }
        .diary-tab:not(.active) {
            border-color: transparent;
            color: #6b7280; /* text-gray-500 */
        }

        /* Stile per i pulsanti disabilitati */
        :disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Stile per text area del diario */
        #diary-page-body {
            min-height: 250px;
            resize: none;
        }
        
                /* --- NUOVI STILI BACHECA --- */
        #whiteboard-container {
            /* Per lo sfondo puntinato */
            background-color: #f9fafb; /* bg-gray-50 */
            background-image: radial-gradient(#d1d5db /* text-gray-400 */ 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #whiteboard-canvas {
            /* Iniziamo con una bacheca grande. 
               La faremo 2000x2000 e il div container la render√† scorrevole */
            background-color: transparent; /* Il canvas √® trasparente per far vedere i puntini sotto */
            width: 2000px;
            height: 2000px;
        }

        
        
    </style>
</head>
<body class="h-screen overflow-hidden bg-gray-50 antialiased">

    <!-- Contenitore principale dell'app -->
    <div class="relative w-full h-full overflow-hidden max-w-lg mx-auto bg-white shadow-2xl">

        <!-- Vista Caricamento -->
        <div id="loading-view" class="app-view visible flex flex-col items-center justify-center h-full bg-white">
            <svg class="animate-spin h-8 w-8 text-custom-pink mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-xl font-medium tracking-wide txt-custom-pink fontTitle">Lume</h2>
            <p class="text-gray-500 mt-1 text-sm">Caricamento...</p>
        </div>

        <!-- Vista Benvenuto -->
        <div id="welcome-view" class="app-view slide-from-bottom flex flex-col justify-between p-8 bg-white">
            <div class="flex-grow flex flex-col items-center justify-center text-center">
                <div class="relative mb-12 mt-16">
                    <img src="/images/1761762271275.png" alt="Mascot Placeholder" class="w-48 h-auto mx-auto rounded-lg" onerror="this.src='https://placehold.co/192x192/F3E8FF/333333?text=Lume'">
                    
                    <div class="absolute -top-10 -left-8 transform -rotate-12">
                        <div class="relative bg-whitr text-white text-lg rounded-full py-3 px-6 ">
                            
                            </div>
                    </div>
                </div>

                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Benvenut…ô in</h1><h1 class="text-6xl font-extrabold txt-custom-pink fontTitle">Lume.</h1>

            </div>
            
            <div class="flex-shrink-0">
                <button id="get-started-btn" class="w-full max-w-md mx-auto p-4 rounded-xl text-gray-900 font-semibold bg-custom-pink transition-opacity duration-300">
    Inizia
</button>

                <p class="text-center text-sm text-gray-600 pt-10">
                    Hai gi√† un account? 
                    <button id="go-to-signin-link" class="font-bold txt-custom-pink">Login</button>
                </p>
            </div>
        </div>

        <!-- Vista Registrazione -->
        <div id="signup-view" class="app-view slide-from-bottom flex flex-col bg-custom-pink">
            <div class="p-8
            1pt-15 flex justify-between items-start flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-950"></h2>
                </div>

            <div class="flex-grow bg-white rounded-t-3xl shadow-2xl p-8 overflow-y-auto">
                <h3 class="text-3xl font-bold txt-custom-pink mb-8">Registrati</h3>
                
                <form id="signup-form" class="space-y-5">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-600 mb-1">Nickname</label>
                        <input id="signup-name" type="text" placeholder="es. Cheddar üßÄ" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                        <input id="signup-email" type="email" placeholder="xoushal@uploopstudio.it" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input id="signup-password" type="password" placeholder="Lume23!!" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    
                    <button id="signup-btn" type="submit" class="w-full bg-custom-pink text-gray-900 font-semibold py-4 px-6 rounded-xl shadow-lg transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink mt-4">
                        Crea Profilo
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink mx-4 text-sm text-gray-400">Or sign up with</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="flex gap-4">
                    <button id="signup-google-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M47.5 24.037C47.5 22.462 47.362 20.937 47.1 19.462H24.475V28.3H37.4C36.962 30.937 35.6 33.15 33.662 34.625V40.275H41.075C45.225 36.337 47.5 30.687 47.5 24.037Z" fill="#F7BBE1"></path><path d="M24.475 48C31.025 48 36.5 45.862 41.075 40.275H33.662C31.45 41.812 28.275 42.75 24.475 42.75C17.825 42.75 12.012 38.362 10.15 32.325H2.562V38.012C6.9 44.05 15.087 48 24.475 48Z" fill="#F7BBE1"></path><path d="M10.15 32.325C9.65 30.85 9.325 29.287 9.325 27.675C9.325 26.062 9.65 24.5 10.15 22.975V17.287H2.562C.925 20.25 0 23.85 0 27.675C0 31.5 0.925 35.1 2.562 38.012L10.15 32.325Z" fill="#F7BBE1"></path><path d="M24.475 9.6C27.9 9.6 31.212 10.762 33.662 13.012L41.15 5.525C36.5 1.5 31.025 0 24.475 0C15.087 0 6.9 3.95 2.562 9.987V17.287H10.15C12.012 11.25 17.825 9.6 24.475 9.6Z" fill="#F7BBE1"></path></svg>
                        Google
                    </button>
                    <button id="signup-facebook-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5 text-[F7BBE1]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987H7.897v-2.89H10.438V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562v1.875h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"></path></svg>
                        Facebook
                    </button>
                </div>

                <p class="text-center text-sm text-gray-600 pt-10">
                    Hai gi√† un account? 
                    <button id="go-to-signin-link-2" class="font-bold txt-custom-pink">Login</button>
                </p>
            </div>
        </div>
        
        <!-- Vista Accesso -->
        <div id="signin-view" class="app-view slide-from-bottom flex flex-col bg-custom-pink">
            <div class="p-8 pt-16 flex-shrink-0 bg-custom-pink">
                <h2 class="text-2xl font-bold text-gray-900"></h2>
            </div>

            <div class="flex-grow bg-white rounded-t-3xl shadow-2xl p-8 overflow-y-auto">
                <h3 class="text-3xl font-bold text-gray-900 mb-8">Sign In</h3>
                
                <form id="signin-form" class="space-y-5">
                    <div>
                        <label for="signin-email" class="block text-sm font-medium text-gray-600 mb-1">Email Address</label>
                        <input id="signin-email" type="email" placeholder="example@gmail.com" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div>
                        <label for="signin-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input id="signin-password" type="password" placeholder="example_1" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    
                    <button id="signin-btn" type="submit" class="w-full bg-custom-pink text-gray-900 font-semibold py-4 px-6 rounded-xl shadow-lg transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink/50 mt-4">
                        Sign In
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink mx-4 text-sm text-gray-400">Or sign in with</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="flex gap-4">
                    <button id="signin-google-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M47.5 24.037C47.5 22.462 47.362 20.937 47.1 19.462H24.475V28.3H37.4C36.962 30.937 35.6 33.15 33.662 34.625V40.275H41.075C45.225 36.337 47.5 30.687 47.5 24.037Z" fill="F7BBE1"></path><path d="M24.475 48C31.025 48 36.5 45.862 41.075 40.275H33.662C31.45 41.812 28.275 42.75 24.475 42.75C17.825 42.75 12.012 38.362 10.15 32.325H2.562V38.012C6.9 44.05 15.087 48 24.475 48Z" fill="#F7BBE1"></path><path d="M10.15 32.325C9.65 30.85 9.325 29.287 9.325 27.675C9.325 26.062 9.65 24.5 10.15 22.975V17.287H2.562C.925 20.25 0 23.85 0 27.675C0 31.5 0.925 35.1 2.562 38.012L10.15 32.325Z" fill="F7BBE1"></path><path d="M24.475 9.6C27.9 9.6 31.212 10.762 33.662 13.012L41.15 5.525C36.5 1.5 31.025 0 24.475 0C15.087 0 6.9 3.95 2.562 9.987V17.287H10.15C12.012 11.25 17.825 9.6 24.475 9.6Z" fill="#EA4335"></path></svg>
                        Google
                    </button>
                    <button id="signin-facebook-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-sm">
                        <svg class="w-5 h-5 text-[#F7BBE1]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987H7.897v-2.89H10.438V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562v1.875h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"></path></svg>
                        Facebook
                    </button>
                </div>

                <p class="text-center text-sm text-gray-600 mt-8">
                    Don't have an account? 
                    <button id="go-to-signup-link" class="font-bold txt-custom-pink hover:underline">Registrati</button>
                </p>
            </div>
        </div>

        <!-- Vista Autenticazione (Pairing) -->
        <div id="auth-view" class="app-view slide-from-bottom flex flex-col items-center justify-center p-8 bg-gray-50">
            
            <div class="max-w-md w-full text-center">
                <h1 class="text-5xl font-extrabold txt-custom-pink fontTitle mb-2">Lume</h1>
                <p class="text-md font-light text-gray-500 mb-10">Connettiti in modo sicuro e istantaneo.</p>
                
                <div class="p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
                    <button id="show-create-tab-button" class="w-full bg-custom-pink text-gray-900 font-semibold py-3 px-6 rounded-xl transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink mb-3">
                        Crea un Nuovo Codice
                    </button>
                    <button id="show-join-tab-button" class="w-full bg-transparent border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-150 hover:bg-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink">
                        Unisciti con un Codice
                    </button>
                </div>

                <button id="signout-btn" class="mt-8 text-sm text-gray-500 hover:text-red-600 hover:underline">
                    Esci
                </button>
            </div>
        </div>

        <!-- Vista Home -->
        <div id="home-view" class="app-view slide-from-bottom flex flex-col bg-custom-pink">
            <!-- Header Home -->
            <header class="bg-pink border-gray-200 p-4 flex items-center justify-between  flex-shrink-0 z-10">
                <h1 class="text-2xl font-extrabold fontTitle text-white">Lume</h1>
                
                <div class="flex items-center space-x-2 pb-15">
                    <span id="partner-status" class="text-xs font-medium px-3 py-1 rounded-full text-pink-700 bg-white-100">...</span>
                    
                    <button id="disconnect-btn" class="text-white hover:text-red-600 p-1" title="Disconnetti partner">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </header>
            
            <!-- Contenuto Home -->
            <div class="flex-grow p-8 rounded-t-3xl shadow-2xl overflow-y-auto bg-gray-50 pt-8">
                

  <!-- SEZIONE EVENTI DINAMICA -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Eventi in Arrivo</h2>
                        <button id="add-event-btn" class="bg-custom-pink text-gray-900 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-transform active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="events-carousel" class="flex overflow-x-auto space-x-4 pb-4 no-scrollbar" style="scroll-snap-type: x mandatory;">
                        <!-- Gli eventi verranno iniettati qui da JS -->
                        <div class="p-5 text-center text-gray-500 w-full">
                            Caricamento eventi...
                        </div>
                    </div>
                </div>


                <!-- SEZIONE ATTIVIT√Ä -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Le Nostre Attivit√†</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- **** MODIFICATO: Aggiunto ID al pulsante Diario **** -->
                        <div id="go-to-diary-btn" class="bg-pink p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Diario</h3>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Wrap Cards</h3>
                        </div>
                        
                                                <!-- SOSTITUISCI IL TUO DIV "Bacheca" ESISTENTE CON QUESTO -->
                        <div id="go-to-whiteboard-btn" class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h.01M15 12h.01M10.5 16.5h.01M13.5 16.5h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Bacheca</h3>
                        </div>


                        <div class="bg-white p-6 rounded-2xl shadow-lg aspect-square flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow border border-gray-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                            <h3 class="font-semibold text-lg text-gray-800">Calendario</h3>
                        </div>
                    </div>
                </div>
            </div> 
            
            <!-- Footer Home -->
             <footer class="flex-shrink-0 bg-white border-t border-gray-200 shadow-inner flex justify-around p-3">
                <button id="nav-home-btn-active" class="flex flex-col items-center text-custom-pink p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 00-1-1h-2a1 1 0 00-1 1v4z" />
                    </svg>
                    <span class="text-xs font-medium">Home</span>
                </button>
                <button id="go-to-profile-btn" class="flex flex-col items-center text-gray-400 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="text-xs font-medium">Profilo</span>
                </button>
             </footer>
        </div>
        
        <!-- **** INIZIO VISTA PROFILO **** -->
        <div id="profile-view" class="app-view slide-from-bottom flex flex-col bg-gray-50">
            <!-- Header Profilo -->
            <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-center shadow-sm flex-shrink-0 z-10 relative">
                <h1 class="text-xl font-bold text-gray-900">Profilo</h1>
                <!-- Potrebbe servire un tasto "indietro" se necessario, ma la nav bar sotto basta -->
            </header>
            
            <!-- Contenuto Profilo -->
            <div class="flex-grow overflow-y-auto p-6">
                <!-- Card Info Utente -->
                <div class="flex flex-col items-center p-6 bg-white rounded-2xl shadow-lg border border-gray-100 mb-8">
                    <div class="w-24 h-24 rounded-full bg-pink-100 flex items-center justify-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-custom-pink" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <h2 id="profile-nickname" class="text-2xl font-bold text-gray-900">@Nickname</h2>
                    <p id="profile-email" class="text-md text-gray-500">email@esempio.com</p>
                    <button id="reset-password-btn" class="mt-4 text-sm font-medium text-custom-pink hover:underline">
                        Resetta Password
                    </button>
                </div>

                <!-- Menu Impostazioni -->
                <nav class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <ul class="divide-y divide-gray-100">
                        <li>
                            <button id="settings-btn" class="w-full flex items-center p-4 text-gray-700 hover:bg-gray-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span class="font-medium">Impostazioni</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </li>
                        <li>
                            <button id="theme-btn" class="w-full flex items-center p-4 text-gray-700 hover:bg-gray-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M12 21v-1m0-16a9 9 0 110 18 9 9 0 010-18z" />
                                </svg>
                                <span class="font-medium">Tema</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </li>
                        <li>
                            <button id="credits-btn" class="w-full flex items-center p-4 text-gray-700 hover:bg-gray-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <span class="font-medium">Crediti</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </li>
                         <li>
                            <button id="profile-logout-btn" class="w-full flex items-center p-4 text-red-600 hover:bg-red-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                <span class="font-medium">Esci</span>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
             <!-- Footer Profilo -->
             <footer class="flex-shrink-0 bg-white border-t border-gray-200 shadow-inner flex justify-around p-3">
                <button id="go-to-home-btn" class="flex flex-col items-center text-gray-400 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 00-1-1h-2a1 1 0 00-1 1v4z" />
                    </svg>
                    <span class="text-xs font-medium">Home</span>
                </button>
                <button id="nav-profile-btn-active" class="flex flex-col items-center text-custom-pink p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">Profilo</span>
                </button>
             </footer>
        </div>
        <!-- **** FINE VISTA PROFILO **** -->
 <!-- **** INIZIO NUOVA VISTA DIARIO **** -->
        <div id="diary-view" class="app-view slide-from-bottom flex flex-col bg-gray-50">
            <!-- Header Diario -->
            <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between shadow-sm flex-shrink-0 z-10 relative">
                <button id="diary-back-btn" class="text-gray-600 hover:text-custom-pink p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-gray-900">Diario</h1>
                <div class="w-8"></div> <!-- Spacer -->
            </header>

            <!-- Contenuto Diario -->
            <div class="flex-grow overflow-y-auto p-4 space-y-4">
                
                <!-- Tab di Navigazione -->
                <div class="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded-xl">
                    <button id="diary-tab-my" class="diary-tab active text-sm font-medium py-2 px-3 rounded-lg border-2">
                        Il Mio Diario
                    </button>
                    <button id="diary-tab-partner" class="diary-tab text-sm font-medium py-2 px-3 rounded-lg border-2">
                        Diario Partner
                    </button>
                </div>

                <!-- Contenitore Pagina -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4">
                    
                    <!-- Info Pagina e Navigazione -->
                    <div class="flex justify-between items-center mb-3">
                        <button id="diary-prev-btn" class="text-gray-500 hover:text-custom-pink p-2 rounded-full disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <span id="diary-page-indicator" class="text-sm font-semibold text-gray-700">Pagina 0 / 0</span>
                        <button id="diary-next-btn" class="text-gray-500 hover:text-custom-pink p-2 rounded-full disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <!-- Input Titolo -->
                    <div>
                        <label for="diary-page-title" class="block text-xs font-medium text-gray-500 mb-1">Titolo</label>
                        <input id="diary-page-title" type="text" placeholder="Titolo della pagina..." class="w-full px-3 py-2 text-lg font-bold rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink read-only:bg-pink read-only:text-pink">
                    </div>

                    <!-- Input Corpo -->
                    <div class="mt-3">
                        <label for="diary-page-body" class="block text-xs font-medium text-gray-500 mb-1">Contenuto</j>
                        <textarea id="diary-page-body" rows="10" placeholder="Cosa √® successo oggi?" class="w-full px-3 py-2 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink read-only:bg-gray-100 read-only:text-gray-600"></textarea>
                    </div>

                    <!-- Metadata -->
                    <div class="text-xs text-gray-400 mt-3 space-y-1">
                        <p>Creato: <span id="diary-created-at">N/D</span></p>
                        <p>Modificato: <span id="diary-updated-at">N/D</span></p>
                    </div>

                    <!-- Messaggio "Nessuna Pagina" -->
                    <div id="diary-no-pages" class="hidden text-center py-10">
                        <p class="text-gray-500">Nessuna pagina trovata.</p>
                        <p id="diary-no-pages-prompt" class="text-gray-400 text-sm mt-1">Crea una nuova pagina per iniziare!</p>
                    </div>

                </div>
            </div>

            <!-- Footer Azioni Diario -->
             <footer class="flex-shrink-0 bg-white border-t border-gray-200 shadow-inner flex justify-around p-3">
                <button id="diary-delete-btn" class="flex flex-col items-center txt-custom-pink p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span class="text-xs font-medium">Elimina</span>
                </button>
                 <button id="diary-new-btn" class="flex flex-col items-center text-custom-pink p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">Nuova</span>
                </button>
                <button id="diary-save-btn" class="flex flex-col items-center txt-custom-pink p-2">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4-4-4 4z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 9H9a1 1 0 00-1 1v4a1 1 0 001 1h6a1 1 0 001-1v-4a1 1 0 00-1-1z" />
                    </svg>
                    <span class="text-xs font-medium">Salva</span>
                </button>
             </footer>
        </div>
        <!-- **** FINE NUOVA VISTA DIARIO **** -->

        <!-- **** INIZIO NUOVA VISTA BACHECA (WHITEBOARD) **** -->
        <div id="whiteboard-view" class="app-view slide-from-bottom flex flex-col bg-gray-100">
            <!-- Header Bacheca -->
            <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between shadow-sm flex-shrink-0 z-10 relative">
                <button id="whiteboard-back-btn" class="text-gray-600 hover:text-custom-pink p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 id="whiteboard-title" class="text-xl font-bold text-gray-900">Bacheca</h1>
                <div class="flex space-x-2">
                    <button id="whiteboard-clear-btn" class="text-gray-600 hover:text-red-500 p-1" title="Pulisci bacheca">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <button id="whiteboard-new-btn" class="text-gray-600 hover:text-custom-pink p-1" title="Nuova bacheca">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Contenitore Canvas (per lo scrolling) -->
            <div id="whiteboard-container" class="flex-grow w-full h-full overflow-auto">
                <canvas id="whiteboard-canvas" class="bg-white cursor-crosshair">
                    Il tuo browser non supporta il canvas.
                </canvas>
            </div>

            <!-- Footer Strumenti (per ora vuoto, ma predisposto) -->
            <footer class="flex-shrink-0 bg-white border-t border-gray-200 shadow-inner flex justify-around p-3">
                 <!-- Qui potremmo aggiungere colori, spessore pennello, ecc. -->
                 <span class="text-sm text-gray-500">Pennello (Default)</span>
            </footer>
        </div>
        <!-- **** FINE NUOVA VISTA BACHECA **** -->


        <!-- Modale Auth (Sheet) -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-end justify-center z-50 transition-opacity duration-300 opacity-0">
            <div id="modal-sheet-content" class="modal-sheet w-full max-w-lg bg-white rounded-t-3xl shadow-2xl p-6 relative">
                
                <div class="handle-bar mb-6 cursor-pointer" id="close-modal-handle"></div>

                <div class="flex flex-col">
                    <div class="flex border-b border-gray-200 mb-8">
                        <button id="tab-create" class="flex-1 text-center py-3 text-sm font-medium border-b-2 transition-all" data-tab="create">Crea</button>
                        <button id="tab-join" class="flex-1 text-center py-3 text-sm font-medium border-b-2 transition-all" data-tab="join">Unisciti</button>
                    </div>

                    <div id="tab-content-create" class="tab-content">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">Il Tuo Codice</h2>
                        <p class="text-gray-500 mb-8 text-center">Condividi questo codice segreto per connetterti:</p>
                        
                        <div class="bg-gray-100 rounded-xl p-6 mb-8 text-center border border-gray-200">
                            <span id="code-display" class="text-6xl font-extrabold tracking-widest text-custom-pink">...</span>
                        </div>
                        
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-3 h-3 bg-custom-pink rounded-full animate-pulse"></div>
                            <div class="w-3 h-3 bg-custom-pink rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                            <div class="w-3 h-3 bg-custom-pink rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                        </div>
                        <p class="text-gray-500 mt-4 text-sm text-center">In attesa che un partner si unisca...</p>
                    </div>

                    <div id="tab-content-join" class="tab-content hidden">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">Inserisci il Codice</h2>
                        <p class="text-gray-500 mb-6 text-center">Digita il codice di 6 cifre fornito dal tuo partner.</p>
                        
                        <input id="code-input" type="number" maxlength="6" class="w-full text-center text-3xl font-bold p-4 rounded-xl border border-gray-300 bg-gray-50 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-pink focus:border-pink transition-colors" placeholder="000000">
                        
                        <button id="join-button" class="w-full bg-pink text-pink font-semibold py-4 px-6 rounded-xl transition-all duration-150 bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink mt-8">
                            Connettiti
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modale Messaggi (Alert) -->
        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center transform transition-all scale-95 border border-gray-200">
                <p id="modal-text" class="text-md text-gray-800 mb-6 whitespace-pre-line"></p>
                <button id="modal-close-button" class="w-full bg-custom-pink text-gray-900 font-semibold py-3 px-6 rounded-lg transition-all hover:bg-custom-pink focus:outline-none focus:ring-2 focus:ring-pink">
                    OK
                </button>
            </div>
        </div>
        

 <!-- Modale Aggiungi Evento -->
        <div id="add-event-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
            <div id="add-event-modal-content" class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-95 border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Nuovo Evento</h3>
                    <button id="close-event-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <form id="add-event-form" class="space-y-4">
                    <div>
                        <label for="event-title" class="block text-sm font-medium text-gray-600 mb-1">Titolo</label>
                        <input id="event-title" type="text" placeholder="es. Cena fuori" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label for="event-date" class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                            <input id="event-date" type="date" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                        </div>
                        <div class="flex-1">
                            <label for="event-time" class="block text-sm font-medium text-gray-600 mb-1">Ora</label>
                            <input id="event-time" type="time" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm" required>
                        </div>
                    </div>
                    <div>
                        <label for="event-description" class="block text-sm font-medium text-gray-600 mb-1">Descrizione (opzionale)</label>
                        <textarea id="event-description" rows="2" placeholder="Ricordati di prenotare!" class="w-full px-4 py-3 text-md rounded-xl border border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-pink shadow-sm"></textarea>
                    </div>
                    
                    <button id="save-event-btn" type="submit" class="w-full bg-custom-pink text-gray-900 font-semibold py-4 px-6 rounded-xl shadow-lg transition-all duration-150 hover:bg-custom-pink active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-pink/50 mt-4">
                        Salva Evento
                    </button>
                </form>
            </div>
        </div>

    </div> <!-- Fine contenitore principale app -->
    
    

    </div> 
    
    <!-- **** INIZIO SCRIPT MODIFICATO **** -->
    <script type="module">
        // Importa funzioni Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,   
            signInWithPopup,              
            GoogleAuthProvider,           
            FacebookAuthProvider,         
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            query, 
            serverTimestamp, 
            setLogLevel,
            limit,
            orderBy,
            getDocs, // <-- AGGIUNGI QUESTO
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali (dall'ambiente Canvas) ---
        
        // Fallback configuration if canvas environment variables are not set
        const userFallbackConfig = {
            apiKey: "AIzaSyDHALYDfyXQIiEzc8IfH7aKjiyXNAWX4_0",
            authDomain: "amicae-99c7b.firebaseapp.com",
            projectId: "amicae-99c7b",
            storageBucket: "amicae-99c7b.firebasestorage.app",
            messagingSenderId: "379845487963",
            appId: "1:379845487963:web:e73dc5c970e627676c7e7e",
            measurementId: "G-LYV92RTCX7"
        };

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : JSON.stringify(userFallbackConfig)); 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inizializzazione Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug');
        } catch (e) {
            console.error("Errore inizializzazione Firebase:", e);
            document.getElementById('loading-view').innerHTML = '<h2 class="text-xl font-semibold text-red-600">Errore di configurazione.</h2>';
        }

        // Stato dell'applicazione
        let userId = null;
        let userNickname = null;
        let pairingCode = null;
        let partnerId = null;
        let partnerNickname = "Partner"; // <-- NUOVO: per UI Diario
        let pairingListenerUnsubscribe = null;
        let eventsListenerUnsubscribe = null; 
        
        let isAuthReady = false; 

        // --- NUOVE VARIABILI DI STATO DIARIO ---
        let myDiaryPages = [];
        let partnerDiaryPages = [];
        let currentDiaryView = 'my'; // 'my' o 'partner'
        let myCurrentPageIndex = -1;
        let partnerCurrentPageIndex = -1;
        let myDiaryListenerUnsubscribe = null;
        let partnerDiaryListenerUnsubscribe = null;
        let isSavingDiary = false; // Flag per evitare doppi salvataggi

  // --- NUOVE VARIABILI STATO BACHECA ---
        let currentWhiteboardId = null;
        let whiteboardStrokes = new Map(); // Cache locale dei tratti {docId: strokeData}
        let currentDrawingStroke = null; // Tratto { points: [], color: '', ... }
        let isDrawing = false;
        let whiteboardStrokesUnsubscribe = null;
        let whiteboardMetaUnsubscribe = null; // Per ascoltare le bacheche
        let allWhiteboards = []; // Lista di tutte le bacheche
        let currentBoardIndex = -1; // Indice della bacheca attuale
        // Offset per il pan (per ora non implementato, ma predisposto)
        let canvasOffsetX = 0;
        let canvasOffsetY = 0;

        // Riferimenti DOM
        const views = {
            
            
            whiteboard: document.getElementById('whiteboard-view'), // <-- AGGIUNGI QUESTO
        
            
            loading: document.getElementById('loading-view'),
            welcome: document.getElementById('welcome-view'), 
            signup: document.getElementById('signup-view'),   
            signin: document.getElementById('signin-view'),   
            auth: document.getElementById('auth-view'),
            home: document.getElementById('home-view'),
            profile: document.getElementById('profile-view'),
            diary: document.getElementById('diary-view') // <-- NUOVA VISTA
        };
        const modal = document.getElementById('auth-modal');
        const modalSheetContent = document.getElementById('modal-sheet-content');
        const codeDisplay = document.getElementById('code-display');
        const codeInput = document.getElementById('code-input');
        const partnerStatus = document.getElementById('partner-status');
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalContent = messageModal.querySelector('div'); 

        // Riferimenti Modale Eventi
        const addEventModal = document.getElementById('add-event-modal');
        const addEventModalContent = document.getElementById('add-event-modal-content');
        const addEventBtn = document.getElementById('add-event-btn');
        const closeEventModalBtn = document.getElementById('close-event-modal-btn');
        const addEventForm = document.getElementById('add-event-form');
        const eventsCarousel = document.getElementById('events-carousel');

        // --- NUOVI RIFERIMENTI DOM DIARIO ---
        const diaryView = document.getElementById('diary-view');
        const diaryTabMy = document.getElementById('diary-tab-my');
        const diaryTabPartner = document.getElementById('diary-tab-partner');
        const diaryPrevBtn = document.getElementById('diary-prev-btn');
        const diaryNextBtn = document.getElementById('diary-next-btn');
        const diaryPageIndicator = document.getElementById('diary-page-indicator');
        const diaryPageTitle = document.getElementById('diary-page-title');
        const diaryPageBody = document.getElementById('diary-page-body');
        const diaryCreatedAt = document.getElementById('diary-created-at');
        const diaryUpdatedAt = document.getElementById('diary-updated-at');
        const diaryNoPages = document.getElementById('diary-no-pages');
        const diaryNoPagesPrompt = document.getElementById('diary-no-pages-prompt');
        const diaryDeleteBtn = document.getElementById('diary-delete-btn');
        const diaryNewBtn = document.getElementById('diary-new-btn');
        const diarySaveBtn = document.getElementById('diary-save-btn');
        
        // --- NUOVI RIFERIMENTI DOM BACHECA ---
        const whiteboardCanvas = document.getElementById('whiteboard-canvas');
        const whiteboardCtx = whiteboardCanvas.getContext('2d');
        const whiteboardContainer = document.getElementById('whiteboard-container');
        const whiteboardBackBtn = document.getElementById('whiteboard-back-btn');
        const whiteboardTitle = document.getElementById('whiteboard-title');
        const whiteboardNewBtn = document.getElementById('whiteboard-new-btn');
        const whiteboardClearBtn = document.getElementById('whiteboard-clear-btn');
        
        // --- Funzioni di Utility ---

        /**
         * Mostra una vista principale con animazione
         * @param {string} viewId 'loading', 'auth', etc.
         */
        function showView(viewId) {
            Object.keys(views).forEach(key => {
                const view = views[key];
                if (key === viewId) {
                    view.classList.add('visible');
                    view.classList.remove('slide-from-bottom');
                } else {
                    view.classList.remove('visible');
                    if (!view.classList.contains('slide-from-bottom')) {
                        view.classList.add('slide-from-bottom');
                    }
                }
            });
            
            if (viewId === 'profile') {
                populateProfileView();
            }

            // NUOVO: Avvia il diario quando si mostra la vista
            if (viewId === 'diary') {
                startDiaryView();
            } else {
                // Interrompi i listener del diario se usciamo
                stopDiaryListeners();
            }
            

            // **** FINE BLOCCO DA MODIFICARE/AGGIUNGERE ****
        }
        
        /**
         * Popola i dati nella vista profilo
         */
        function populateProfileView() {
            if (!auth.currentUser) return;
            
            document.getElementById('profile-email').textContent = auth.currentUser.email || "Email non disponibile";
            
            if (userNickname) {
                 document.getElementById('profile-nickname').textContent = '@' + userNickname;
            } else {
                console.log("Nickname non in cache, eseguo fetch...");
                getDoc(doc(db, 'users', userId)).then(docSnap => {
                    if (docSnap.exists()) {
                        userNickname = docSnap.data().nickname;
                        document.getElementById('profile-nickname').textContent = '@' + userNickname;
                    } else {
                        document.getElementById('profile-nickname').textContent = '@utente';
                    }
                }).catch(e => console.error("Errore fetch profilo:", e));
            }
        }


        /**
         * Mostra un messaggio modale (sostituto di alert)
         * @param {string} message Testo da mostrare
         */
        function showMessage(message) {
            let friendlyMessage = message;
            // ... (gestione errori esistente) ...
            if (message.includes("auth/email-already-in-use")) {
                friendlyMessage = "Questo indirizzo email √® gi√† in uso. Prova ad accedere.";
            } else if (message.includes("auth/wrong-password") || message.includes("auth/user-not-found") || message.includes("auth/invalid-credential")) {
                friendlyMessage = "Email o password non corretti. Riprova.";
            } else if (message.includes("auth/weak-password")) {
                friendlyMessage = "La password deve essere di almeno 6 caratteri.";
            } else if (message.includes("auth/invalid-email")) {
                friendlyMessage = "L'indirizzo email non √® valido.";
            } else if (message.includes("auth/popup-closed-by-user")) {
                friendlyMessage = "Accesso annullato.";
            }
            
            modalText.textContent = friendlyMessage;
            messageModal.classList.remove('hidden');
            setTimeout(() => {
                messageModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }
        document.getElementById('modal-close-button').addEventListener('click', () => {
            messageModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => messageModal.classList.add('hidden'), 300);
        });
          /**
         * NUOVO: Formattatore data per il diario
         */
        function formatDiaryTimestamp(timestamp) {
            if (!timestamp) return "N/D";
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('it-IT', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } catch (e) {
                console.warn("Timestamp non valido:", timestamp, e);
                return "Data non valida";
            }
        }

        // --- Logica Modale Auth (Sheet) ---
        
        function openAuthModal(tab) {
            if (!isAuthReady || !userId) {
                showMessage("Devi essere connesso per usare questa funzione.");
                return;
            }
            modal.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalSheetContent.classList.add('open');
            }, 10);
            switchTab(tab);
        }

        function closeAuthModal() {
            modalSheetContent.classList.remove('open');
            setTimeout(() => {
                modal.classList.add('opacity-0');
                modal.classList.add('hidden');
            }, 300);
            if (pairingListenerUnsubscribe) {
                pairingListenerUnsubscribe();
                pairingListenerUnsubscribe = null;
                codeDisplay.textContent = '...';
            }
        }
        document.getElementById('show-create-tab-button').addEventListener('click', () => openAuthModal('create'));
        document.getElementById('show-join-tab-button').addEventListener('click', () => openAuthModal('join'));
        document.getElementById('close-modal-handle').addEventListener('click', closeAuthModal);
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'auth-modal') closeAuthModal();
        });

        const tabContents = { create: document.getElementById('tab-content-create'), join: document.getElementById('tab-content-join') };
        const tabButtons = { create: document.getElementById('tab-create'), join: document.getElementById('tab-join') };
        
        function switchTab(tabId) {
            Object.keys(tabContents).forEach(key => {
                if (key === tabId) {
                    tabContents[key].classList.remove('hidden');
                    tabButtons[key].classList.add('text-custom-pink', 'border-pink');
                } else {
                    tabContents[key].classList.add('hidden');
                    tabButtons[key].classList.remove('text-custom-pink', 'border-pink');
                    tabButtons[key].classList.add('text-gray-500', 'border-transparent', 'hover:border-pink');
                }
            });
            if (tabId === 'join') codeInput.value = '';
            if (tabId === 'join' && pairingListenerUnsubscribe) {
                pairingListenerUnsubscribe();
                pairingListenerUnsubscribe = null;
                codeDisplay.textContent = '...';
            }
            if (tabId === 'create' && !pairingListenerUnsubscribe) {
                handleCreateConnection();
            }
        }

        tabButtons.create.addEventListener('click', () => switchTab('create'));
        tabButtons.join.addEventListener('click', () => switchTab('join'));

        
        // --- Logica di Persistenza Pairing ---

        async function updateUserPairing(uid, pId, pCode) {
            if (!uid) return;
            const userDocRef = doc(db, 'users', uid); 
            try {
                await setDoc(userDocRef, { 
                    currentPairingCode: pCode,
                    currentPartnerId: pId
                }, { merge: true });
                console.log(`Dati pairing aggiornati per utente ${uid}`);
            } catch (error) {
                console.error(`Errore aggiornamento pairing per ${uid}:`, error);
            }
        }


        // --- Logica di Autenticazione (MODIFICATA) ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Utente autenticato:", user.uid);
                userId = user.uid;
                isAuthReady = true;
                
                try {
                    const userDocRef = doc(db, 'users', userId);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        userNickname = userData.nickname;
                        
                        if (userData.currentPairingCode) {
                            pairingCode = userData.currentPairingCode;
                            partnerId = userData.currentPartnerId; 

                            console.log(`Pairing ${pairingCode} trovato. Avvio Home.`);
                            
                            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);
                            const pairDocSnap = await getDoc(pairDocRef);

                            if (pairDocSnap.exists() && pairDocSnap.data().status === 'connected') {
                                startHomeView();
                            } else {
                                console.warn("Pairing salvato non valido. Resetto.");
                                await updateUserPairing(userId, null, null); 
                                partnerId = null;
                                pairingCode = null;
                                showView('auth'); 
                            }
                        } else {
                            console.log("Nessun pairing salvato. Mostro Auth view.");
                            showView('auth');
                        }
                    } else {
                        console.warn("Documento utente non trovato! Mostro Auth view.");
                        await setDoc(userDocRef, { email: user.email, nickname: "Utente" }, { merge: true });
                        userNickname = "Utente";
                        showView('auth');
                    }
                } catch (error) {
                    console.error("Errore nel recupero dati utente:", error);
                    showView('auth'); // Fallback
                }

            } else {
                console.log("Nessun utente, mostro la welcome view.");
                userId = null;
                userNickname = null;
                partnerId = null; 
                partnerNickname = "Partner"; // Resetta
                pairingCode = null; 
                isAuthReady = true;
                setTimeout(() => showView('welcome'), 500); 
            }
        });


        // Tenta il login con token custom se esiste (per ambiente Canvas)
        (async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Nessun token iniziale, in attesa di login manuale.");
                }
            } catch (error) {
                console.error("Errore con token iniziale:", error);
            }
        })();

        // --- Listener per le viste di Login/Registrazione ---

        document.getElementById('get-started-btn').addEventListener('click', () => showView('signup'));
        document.getElementById('go-to-signin-link').addEventListener('click', () => showView('signin'));
        document.getElementById('go-to-signin-link-2').addEventListener('click', () => showView('signin'));
        document.getElementById('go-to-signup-link').addEventListener('click', () => showView('signup'));

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const nickname = document.getElementById('signup-name').value;
            
            if (!nickname) {
                showMessage("Il nickname √® obbligatorio.");
                return;
            }

            try {
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCred.user;
                
                await setDoc(doc(db, 'users', user.uid), {
                    nickname: nickname,
                    email: user.email
                });
                userNickname = nickname;
                
            } catch (error) {
                showMessage(error.message);
            }
        });

        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage(error.message);
            }
        });

        const handleSocialLogin = async (providerName) => {
            const provider = providerName === 'google' 
                ? new GoogleAuthProvider() 
                : new FacebookAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    nickname: user.displayName || "Utente Social",
                    email: user.email
                }, { merge: true });
                
            } catch (error) {
                showMessage(error.message);
            }
        };

        document.getElementById('signup-google-btn').addEventListener('click', () => handleSocialLogin('google'));
        document.getElementById('signup-facebook-btn').addEventListener('click', () => handleSocialLogin('facebook'));
        document.getElementById('signin-google-btn').addEventListener('click', () => handleSocialLogin('google'));
        document.getElementById('signin-facebook-btn').addEventListener('click', () => handleSocialLogin('facebook'));

        async function handleSignOut() {
            try {
                await signOut(auth);
                // Resetta lo stato
                if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();
                if (eventsListenerUnsubscribe) eventsListenerUnsubscribe();
                stopDiaryListeners(); // <-- NUOVO
                
                stopWhiteboardListeners(); // <-- AGGIUNGI QUESTO
                pairingListenerUnsubscribe = null;
                eventsListenerUnsubscribe = null;
                
                userId = null;
                userNickname = null;
                partnerId = null;
                partnerNickname = "Partner";
                pairingCode = null;
            } catch (error) {
                showMessage(error.message);
            }
        }
        
        document.getElementById('signout-btn').addEventListener('click', handleSignOut);
        document.getElementById('profile-logout-btn').addEventListener('click', handleSignOut);


        // --- Logica di Connessione (Pairing) ---

        async function handleCreateConnection() {
            if (!userId) return;
            
            if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();

            const newCode = Math.floor(100000 + Math.random() * 900000).toString();
            pairingCode = newCode;
            
            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);
            
            try {
                await setDoc(pairDocRef, {
                    initiatorId: userId,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                codeDisplay.textContent = pairingCode;
                listenForPairing(pairDocRef); 
            } catch (error) {
                console.error("Errore creazione connessione:", error);
                showMessage("Impossibile creare la connessione. Riprova.");
                closeAuthModal();
            }
        }

        document.getElementById('join-button').addEventListener('click', async () => {
            if (!userId) return;

            const code = codeInput.value.trim();
            if (code.length !== 6) {
                showMessage("Il codice deve essere di 6 cifre.");
                return;
            }

            pairingCode = code;
            const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);

            try {
                const docSnap = await getDoc(pairDocRef);

                if (!docSnap.exists() || docSnap.data().status !== 'pending') {
                    showMessage("Codice non valido o gi√† utilizzato.");
                    return;
                }
                
                const initiatorId = docSnap.data().initiatorId;
                if (initiatorId === userId) {
                    showMessage("Non puoi connetterti con te stesso!");
                    return;
                }

                await updateDoc(pairDocRef, {
                    joinerId: userId,
                    status: 'connected'
                });

                partnerId = initiatorId;

                await updateUserPairing(userId, partnerId, pairingCode); 
                await updateUserPairing(partnerId, userId, pairingCode); 

                closeAuthModal();
                showMessage("Connesso! Benvenuti.");
                startHomeView(); 

            } catch (error) {
                console.error("Errore unione connessione:", error);
                showMessage("Impossibile unirsi. Controlla il codice.");
            }
        });
        
        function listenForPairing(docRef) {
            pairingListenerUnsubscribe = onSnapshot(docRef, async (docSnap) => { 
                if (docSnap.exists() && docSnap.data().status === 'connected') {
                    partnerId = docSnap.data().joinerId;
                    
                    await updateUserPairing(userId, partnerId, pairingCode); 
                    await updateUserPairing(partnerId, userId, pairingCode); 

                    if (pairingListenerUnsubscribe) pairingListenerUnsubscribe();
                    closeAuthModal();
                    showMessage("Partner connesso! Benvenuti.");
                    startHomeView();
                }
            }, (error) => {
                console.error("Errore ascolto pairing:", error);
                showMessage("Errore di connessione. Riprova.");
                closeAuthModal();
            });
        }
          // --- Logica App Principale (Home) ---

        function startHomeView() {
            showView('home');
            
            if (partnerId) {
                getDoc(doc(db, 'users', partnerId)).then(docSnap => {
                    if (docSnap.exists()) {
                         partnerNickname = docSnap.data().nickname || "Partner"; // Salva nickname partner
                         partnerStatus.textContent = `Connesso con: @${partnerNickname}`;
                         diaryTabPartner.textContent = `Diario di @${partnerNickname}`; // Aggiorna tab diario
                    } else {
                        partnerStatus.textContent = `Connesso con: ${partnerId.substring(0, 6)}...`; 
                        diaryTabPartner.textContent = `Diario Partner`;
                    }
                    partnerStatus.classList.add('text-pink-700', 'bg-pink-100');
                });
            }
            
            listenForEvents();
        }
         // --- Logica Eventi ---

        function formatEventDate(isoString) {
            if (!isoString) return "Data non specificata";
            try {
                const date = new Date(isoString);
                const options = {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                let formatted = new Intl.DateTimeFormat('it-IT', options).format(date);
                formatted = formatted.replace('alle', '');
                return formatted;
            } catch (e) {
                console.error("Errore formattazione data:", e);
                return "Data non valida";
            }
        }
        
        function listenForEvents() {
            if (!pairingCode) {
                console.warn("listenForEvents chiamato senza pairingCode.");
                return;
            }
            if (eventsListenerUnsubscribe) {
                eventsListenerUnsubscribe(); 
            }

            const eventsCollectionRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'events');
            const q = query(eventsCollectionRef, orderBy("eventDate", "asc"));
            
            eventsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                renderEvents(snapshot.docs);
            }, (error) => {
                console.error("Errore ascolto eventi:", error);
                eventsCarousel.innerHTML = '<div class="p-5 text-center text-red-500 w-full">Errore nel caricare gli eventi.</div>';
            });
        }

        function renderEvents(docs) {
            eventsCarousel.innerHTML = ''; 

            if (docs.length === 0) {
                eventsCarousel.innerHTML = `
                    <div class="flex-shrink-0 w-full text-center p-5">
                        <p class="text-gray-500">Nessun evento in programma.</p>
                        <p class="text-gray-400 text-sm">Aggiungine uno con il tasto '+'!</p>
                    </div>
                `;
                return;
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const upcomingDocs = docs.filter(doc => new Date(doc.data().eventDate) >= today);

            if (upcomingDocs.length === 0) {
                eventsCarousel.innerHTML = `
                    <div class="flex-shrink-0 w-full text-center p-5">
                        <p class="text-gray-500">Nessun evento futuro.</p>
                         <p class="text-gray-400 text-sm">Aggiungine uno nuovo!</p>
                    </div>
                `;
                 return;
            }

            upcomingDocs.forEach(doc => {
                const event = doc.data();
                const eventDate = new Date(event.eventDate);

                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('it-IT', { month: 'short' }).toUpperCase().replace('.', '');

                const fullFormattedDate = formatEventDate(event.eventDate);

                const eventCardHTML = `
                    <div class="flex-shrink-0 w-4/5 max-w-xs bg-white p-5 rounded-2xl shadow-lg border border-gray-100" style="scroll-snap-align: start;">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-bold text-lg text-gray-900 truncate">${event.title}</h3>
                                <p class="text-sm text-custom-pink font-medium">${fullFormattedDate}</p>
                            </div>
                            <div class="text-center flex-shrink-0 ml-4">
                                <span class="block text-3xl font-bold text-custom-pink">${day}</span>
                                <span class="block text-xs font-medium text-gray-500 uppercase">${month}</span>
                            </div>
                        </div>
                        ${event.description ? `<p class="text-sm text-gray-600">${event.description}</p>` : ''}
                    </div>
                `;
                eventsCarousel.innerHTML += eventCardHTML;
            });
        }

        // --- Listener Modale Eventi ---
        
        function openEventModal() {
            addEventForm.reset(); 
            addEventModal.classList.remove('hidden');
            setTimeout(() => {
                addEventModal.classList.remove('opacity-0');
                addEventModalContent.classList.remove('scale-95');
            }, 10);
        }
        
        function closeEventModal() {
            addEventModal.classList.add('opacity-0');
            addEventModalContent.classList.add('scale-95');
            setTimeout(() => addEventModal.classList.add('hidden'), 300);
        }

        addEventBtn.addEventListener('click', openEventModal);
        closeEventModalBtn.addEventListener('click', closeEventModal);
        
        addEventModal.addEventListener('click', (e) => {
            if (e.target.id === 'add-event-modal') closeEventModal();
        });

        addEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!pairingCode) {
                showMessage("Errore: Connessione non trovata.");
                return;
            }

            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const description = document.getElementById('event-description').value;
            
            if (!title || !date || !time) {
                showMessage("Titolo, data e ora sono obbligatori.");
                return;
            }
            
            const eventDateISO = `${date}T${time}`;
            const eventDateObj = new Date(eventDateISO);
            const now = new Date();
            
            if (eventDateObj < now) {
                showMessage("Non puoi aggiungere un evento nel passato.");
                return;
            }

            try {
                const eventsCollectionRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'events');
                
                await addDoc(eventsCollectionRef, {
                    title: title,
                    eventDate: eventDateISO,
                    description: description,
                    createdBy: userId,
                    createdAt: serverTimestamp()
                });

                showMessage("Evento aggiunto con successo!");
                closeEventModal();

            } catch (error) {
                console.error("Errore salvataggio evento: ", error);
                showMessage("Impossibile salvare l'evento. Riprova.");
            }
        });
        
        /**
         * Listener per il pulsante Disconnetti
         */
        document.getElementById('disconnect-btn').addEventListener('click', async () => {
            console.log("Disconnessione partner...");

            if (userId) await updateUserPairing(userId, null, null); 
            if (partnerId) await updateUserPairing(partnerId, null, null); 
            
            if (pairingCode) {
                try {
                    const pairDocRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode);
                    await updateDoc(pairDocRef, { status: 'disconnected', disconnectedAt: serverTimestamp() });
                } catch (e) { console.warn("Impossibile aggiornare vecchio pairing:", e.message); }
            }

            partnerId = null;
            partnerNickname = "Partner";
            pairingCode = null;
            if (eventsListenerUnsubscribe) { 
                eventsListenerUnsubscribe();
                eventsListenerUnsubscribe = null;
            }
            stopDiaryListeners(); // <-- NUOVO
            
            stopWhiteboardListeners(); // <-- AGGIUNGI QUESTO

            eventsCarousel.innerHTML = ''; 
            showView('auth');
            showMessage("Partner disconnesso.");
        });
        
        
        // --- Listener Profilo ---
        
        document.getElementById('go-to-profile-btn').addEventListener('click', () => showView('profile'));
        document.getElementById('go-to-home-btn').addEventListener('click', () => showView('home'));
        
        document.getElementById('reset-password-btn').addEventListener('click', async () => {
            if (!auth.currentUser || !auth.currentUser.email) {
                 showMessage("Email utente non trovata. Impossibile resettare.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, auth.currentUser.email);
                showMessage("Email per il reset della password inviata. Controlla la tua casella di posta.");
            } catch (error) {
                console.error("Errore reset password:", error);
                showMessage("Errore: " + error.message);
            }
        });
        
        document.getElementById('credits-btn').addEventListener('click', () => {
            showMessage('Sviluppato da Christian "Xoushal" Vedovi.\nCon il contributo di Luca "Dragons" Stecchetti.');
        });
        
        document.getElementById('settings-btn').addEventListener('click', () => {
            showMessage("Funzione Impostazioni non ancora implementata.");
        });
         document.getElementById('theme-btn').addEventListener('click', () => {
            showMessage("Funzione Tema non ancora implementata.");
        });

        // --- **** NUOVA LOGICA DIARIO **** ---

        // 1. Avvio della vista Diario
        document.getElementById('go-to-diary-btn').addEventListener('click', () => {
            showView('diary');
        });

        document.getElementById('diary-back-btn').addEventListener('click', () => {
            showView('home');
        });
        
        // --- NUOVI LISTENER NAVIGAZIONE BACHECA ---
        document.getElementById('go-to-whiteboard-btn').addEventListener('click', () => {
            showView('whiteboard');
        });

        document.getElementById('whiteboard-back-btn').addEventListener('click', () => {
            showView('home');
        });

        function startDiaryView() {
            if (!userId || !pairingCode) {
                showMessage("Errore: devi essere connesso a un partner per usare il diario.");
                showView('home');
                return;
            }
            
            // Imposta la tab "Il Mio Diario" come predefinita
            currentDiaryView = 'my';
            diaryTabMy.classList.add('active');
            diaryTabPartner.classList.remove('active');
            
            // Avvia i listener per entrambi i diari
            loadMyDiary();
            loadPartnerDiary();
            
            // Renderizza la pagina (inizialmente il mio diario)
            renderDiaryPage();
        }

        function stopDiaryListeners() {
            if (myDiaryListenerUnsubscribe) {
                myDiaryListenerUnsubscribe();
                myDiaryListenerUnsubscribe = null;
                console.log("Listener mio diario stoppato.");
            }
            if (partnerDiaryListenerUnsubscribe) {
                partnerDiaryListenerUnsubscribe();
                partnerDiaryListenerUnsubscribe = null;
                console.log("Listener diario partner stoppato.");
            }
            // Resetta stato
            myDiaryPages = [];
            partnerDiaryPages = [];
            myCurrentPageIndex = -1;
            partnerCurrentPageIndex = -1;
        }

        // 2. Caricamento Dati
        function loadMyDiary() {
            if (myDiaryListenerUnsubscribe) return; // Gi√† in ascolto
            if (!userId || !pairingCode) return;

            const myDiaryRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'diaries', userId, 'pages');
            const q = query(myDiaryRef, orderBy("createdAt", "asc"));

            myDiaryListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                myDiaryPages = snapshot.docs;
                console.log(`Caricate ${myDiaryPages.length} pagine mie.`);

                // Aggiusta l'indice corrente
                if (myDiaryPages.length === 0) {
                    myCurrentPageIndex = -1;
                } else if (myCurrentPageIndex === -1) {
                    myCurrentPageIndex = 0; // Vai alla prima pagina se prima era vuoto
                } else if (myCurrentPageIndex >= myDiaryPages.length) {
                    // L'indice √® fuori range (es. pagina eliminata), vai all'ultima
                    myCurrentPageIndex = myDiaryPages.length - 1;
                }
                
                // Aggiorna la vista solo se stiamo guardando il mio diario
                if (currentDiaryView === 'my') {
                    renderDiaryPage();
                }
            }, (error) => {
                console.error("Errore caricamento mio diario:", error);
                showMessage("Impossibile caricare il tuo diario.");
            });
        }

        function loadPartnerDiary() {
            if (partnerDiaryListenerUnsubscribe) return; // Gi√† in ascolto
            if (!partnerId || !pairingCode) return;

            const partnerDiaryRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'diaries', partnerId, 'pages');
            const q = query(partnerDiaryRef, orderBy("createdAt", "asc"));

            partnerDiaryListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                partnerDiaryPages = snapshot.docs;
                console.log(`Caricate ${partnerDiaryPages.length} pagine partner.`);

                // Aggiusta l'indice corrente
                if (partnerDiaryPages.length === 0) {
                    partnerCurrentPageIndex = -1;
                } else if (partnerCurrentPageIndex === -1) {
                    partnerCurrentPageIndex = 0;
                } else if (partnerCurrentPageIndex >= partnerDiaryPages.length) {
                    partnerCurrentPageIndex = partnerDiaryPages.length - 1;
                }
                
                // Aggiorna la vista solo se stiamo guardando il diario partner
                if (currentDiaryView === 'partner') {
                    renderDiaryPage();
                }
            }, (error) => {
                console.error("Errore caricamento diario partner:", error);
                // Non mostrare errore, potrebbero non aver ancora scritto nulla
            });
        }

        // 3. Renderizzazione
        function renderDiaryPage() {
            const isMyView = (currentDiaryView === 'my');
            const pages = isMyView ? myDiaryPages : partnerDiaryPages;
            const index = isMyView ? myCurrentPageIndex : partnerCurrentPageIndex;
            
            const hasPages = (index !== -1 && pages.length > 0);

            if (hasPages) {
                const pageData = pages[index].data();
                
                diaryNoPages.classList.add('hidden');
                diaryPageTitle.value = pageData.title || "";
                diaryPageBody.value = pageData.body || "";
                diaryCreatedAt.textContent = formatDiaryTimestamp(pageData.createdAt);
                diaryUpdatedAt.textContent = formatDiaryTimestamp(pageData.updatedAt);
                diaryPageIndicator.textContent = `Pagina ${index + 1} / ${pages.length}`;
            } else {
                // Nessuna pagina da mostrare
                diaryNoPages.classList.remove('hidden');
                diaryPageTitle.value = "";
                diaryPageBody.value = "";
                diaryCreatedAt.textContent = "N/D";
                diaryUpdatedAt.textContent = "N/D";
                diaryPageIndicator.textContent = "Pagina 0 / 0";
                
                if(isMyView) {
                    diaryNoPagesPrompt.textContent = "Crea una nuova pagina per iniziare!";
                } else {
                    diaryNoPagesPrompt.textContent = `@${partnerNickname} non ha ancora scritto nulla.`;
                }
            }

            // Imposta stato Read-Only e visibilit√† pulsanti
            diaryPageTitle.readOnly = !isMyView;
            diaryPageBody.readOnly = !isMyView;

            diarySaveBtn.style.display = isMyView ? 'flex' : 'none';
            diaryNewBtn.style.display = isMyView ? 'flex' : 'none';
            diaryDeleteBtn.style.display = (isMyView && hasPages) ? 'flex' : 'none'; // Mostra solo se ci sono pagine

            // Abilita/Disabilita pulsanti navigazione
            diaryPrevBtn.disabled = (index <= 0);
            diaryNextBtn.disabled = (index >= pages.length - 1 || !hasPages);
        }

        // 4. Listener Eventi UI Diario

        diaryTabMy.addEventListener('click', () => {
            currentDiaryView = 'my';
            diaryTabMy.classList.add('active');
            diaryTabPartner.classList.remove('active');
            renderDiaryPage();
        });

        diaryTabPartner.addEventListener('click', () => {
            currentDiaryView = 'partner';
            diaryTabMy.classList.remove('active');
            diaryTabPartner.classList.add('active');
            renderDiaryPage();
        });

        diaryPrevBtn.addEventListener('click', () => {
            if (currentDiaryView === 'my' && myCurrentPageIndex > 0) {
                myCurrentPageIndex--;
            } else if (currentDiaryView === 'partner' && partnerCurrentPageIndex > 0) {
                partnerCurrentPageIndex--;
            }
            renderDiaryPage();
        });
diaryNextBtn.addEventListener('click', () => {
            if (currentDiaryView === 'my' && myCurrentPageIndex < myDiaryPages.length - 1) {
                myCurrentPageIndex++;
            } else if (currentDiaryView === 'partner' && partnerCurrentPageIndex < partnerDiaryPages.length - 1) {
                partnerCurrentPageIndex++;
            }
            renderDiaryPage();
        });

        diaryNewBtn.addEventListener('click', async () => {
            if (currentDiaryView !== 'my' || !userId || !pairingCode) return;

            try {
                const myDiaryRef = collection(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'diaries', userId, 'pages');
                
                // Aggiungi la nuova pagina
                const newPage = {
                    title: "Nuova Pagina",
                    body: "",
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                const docRef = await addDoc(myDiaryRef, newPage);
                
                // Il listener onSnapshot aggiorner√† myDiaryPages.
                // Vogliamo impostare l'indice sulla nuova pagina, che sar√† l'ultima.
                myCurrentPageIndex = myDiaryPages.length; // L'array non √® ancora aggiornato, quindi .length √® il nuovo ultimo indice
                
                // renderDiaryPage() sar√† chiamato da onSnapshot
                console.log("Nuova pagina creata, in attesa di snapshot...");

            } catch (error) {
                console.error("Errore creazione pagina:", error);
                showMessage("Impossibile creare la pagina.");
            }
        });

        diarySaveBtn.addEventListener('click', async () => {
            if (currentDiaryView !== 'my' || myCurrentPageIndex === -1 || !userId || !pairingCode || isSavingDiary) return;
            
            isSavingDiary = true;
            try {
                const pageId = myDiaryPages[myCurrentPageIndex].id;
                const pageRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'diaries', userId, 'pages', pageId);

                const updatedData = {
                    title: diaryPageTitle.value,
                    body: diaryPageBody.value,
                    updatedAt: serverTimestamp()
                };

                await updateDoc(pageRef, updatedData);
                showMessage("Pagina salvata!");
                
            } catch (error) {
                console.error("Errore salvataggio pagina:", error);
                showMessage("Impossibile salvare la pagina.");
            } finally {
                isSavingDiary = false;
            }
        });

        diaryDeleteBtn.addEventListener('click', async () => {
            if (currentDiaryView !== 'my' || myCurrentPageIndex === -1 || !userId || !pairingCode) return;

            // NOTA: Come da istruzioni, non uso un 'confirm()' bloccante.
            // L'utente deve essere sicuro.
            
            try {
                const pageId = myDiaryPages[myCurrentPageIndex].id;
                const pageRef = doc(db, 'artifacts', appId, 'public/data/pairings', pairingCode, 'diaries', userId, 'pages', pageId);

                await deleteDoc(pageRef);
                
                // L'indice verr√† aggiustato da onSnapshot
                showMessage("Pagina eliminata.");

            } catch (error) {
                console.error("Errore eliminazione pagina:", error);
                showMessage("Impossibile eliminare la pagina.");
            }
        });


    </script>
    <!-- **** FINE SCRIPT MODIFICATO **** -->
</body>
</html>

